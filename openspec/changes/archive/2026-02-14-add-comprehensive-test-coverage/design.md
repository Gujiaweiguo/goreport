## Context

GoReport 系统当前拥有 22 个能力规格，涵盖认证、数据源、数据集、报表、仪表盘、图表等核心功能。后端有 52 个测试文件，前端有 20 个测试文件，但测试覆盖率缺乏统一标准和系统性规划。

**当前测试状态**:
- 后端: 各模块单元测试已建立，集成测试部分覆盖
- 前端: API 测试和组件测试已有基础，E2E 测试缺失
- CI/CD: 有基础测试执行，但无覆盖率门禁

## Goals / Non-Goals

### Goals
1. 建立测试覆盖率目标和度量标准
2. 为所有 P0 需求场景提供测试覆盖
3. 建立系统化的测试数据管理机制
4. 集成测试覆盖率到 CI/CD 流程

### Non-Goals
1. 不追求 100% 覆盖率（成本过高）
2. 不引入新的测试框架（复用现有 Go test + Vitest）
3. 不包含性能基准测试（另行规划）
4. 不包含安全渗透测试（另行规划）

## Decisions

### 1. 测试覆盖率目标

**决定**: 采用分级覆盖率目标

| 层级 | 目标 | 理由 |
|------|------|------|
| 后端整体 | ≥ 80% | 核心业务逻辑需高覆盖 |
| 后端 P0 模块 | ≥ 90% | auth、dataset、datasource 关键路径 |
| 前端整体 | ≥ 70% | UI 测试复杂度较高 |
| 前端 API 层 | ≥ 90% | 纯逻辑层易测试 |

**备选方案**:
- A. 统一 80% 覆盖率 → 拒绝，前端达成成本过高
- B. 不设门禁，仅监控 → 拒绝，无法保证质量

### 2. 测试类型层次

**决定**: 采用金字塔模型

```
        /\
       /E2E\        5% - 关键业务流程
      /------\
     / 集成测试 \    25% - API 集成、DB 集成
    /----------\
   /   单元测试  \  70% - 函数、方法级别
  /--------------\
```

**实施策略**:
- 优先补充单元测试（投资回报最高）
- 集成测试聚焦租户隔离和跨模块交互
- E2E 测试仅覆盖核心业务流程

### 3. 测试数据管理

**决定**: 扩展现有 `testutil/` 包

```go
// 统一的测试数据工厂模式
type TestFixture interface {
    Setup(db *gorm.DB) error
    Cleanup(db *gorm.DB) error
}

// 租户隔离测试上下文
type TenantTestContext struct {
    TenantID string
    UserID   string
    DB       *gorm.DB
}
```

**优势**:
- 与现有代码风格一致
- 支持测试并行执行
- 自动清理机制

### 4. CI/CD 集成

**决定**: 分阶段引入覆盖率门禁

| 阶段 | 覆盖率基线 | 时长 |
|------|-----------|------|
| Phase 1 | 60% (报告) | 2 周 |
| Phase 2 | 70% (警告) | 2 周 |
| Phase 3 | 80% (门禁) | 持续 |

**工作流变更**:
```yaml
# .github/workflows/test.yml
- name: Backend Test
  run: |
    cd backend && go test ./... -coverprofile=coverage.out
    ./scripts/ci/check-coverage.sh 80  # 门禁脚本
```

## Risks / Trade-offs

### Risk 1: 覆盖率门禁阻塞开发
**缓解**: 
- 分阶段实施，给予缓冲期
- 提供覆盖率报告工具帮助定位未覆盖代码

### Risk 2: E2E 测试不稳定
**缓解**:
- 仅保留最关键流程的 E2E 测试
- 使用重试机制处理偶发性失败
- Mock 外部依赖（如 Redis）

### Risk 3: 测试维护成本
**缓解**:
- 使用 fixture 工厂减少测试数据维护
- 优先测试公共 API，减少内部实现细节测试

## Migration Plan

### Phase 1: 基础设施（1 周）
1. 创建 `testing-coverage` 能力规格
2. 扩展 `testutil/` 包
3. 添加覆盖率 CI 脚本

### Phase 2: P0 模块覆盖（2 周）
1. auth 模块测试补充
2. datasource 模块测试补充
3. dataset 模块测试补充

### Phase 3: 前端覆盖（1 周）
1. API 层测试补充
2. 核心组件测试补充

### Phase 4: 门禁启用（持续）
1. 启用覆盖率报告
2. 逐步提升门禁阈值

### Rollback
如覆盖率门禁严重影响开发效率：
1. 将门禁改为警告模式
2. 调整覆盖率目标
3. 临时排除特定模块

## Open Questions

1. **Q**: 是否需要为前端添加 E2E 测试框架（如 Playwright）？
   **A**: 暂不引入，当前以 API 和组件测试为主，E2E 测试另行评估

2. **Q**: 测试覆盖率是否包含生成的代码（如 GORM 模型）？
   **A**: 不包含，覆盖率统计排除 `*_gen.go` 和 `models/` 目录

3. **Q**: 如何处理需要外部依赖（MySQL、Redis）的集成测试？
   **A**: 使用 Docker Compose 测试环境，通过 `TEST_DB_DSN` 环境变量配置
