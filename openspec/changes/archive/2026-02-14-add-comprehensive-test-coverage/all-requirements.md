# GoReport 系统需求文档

**生成日期:** 2026-02-14  
**文档版本:** 1.0  
**基于:** OpenSpec 规范汇总 (22 个能力规格 + 19 个已归档变更)

---

## 目录

1. [系统概述](#1-系统概述)
2. [认证与授权](#2-认证与授权)
3. [数据源管理](#3-数据源管理)
4. [数据集管理](#4-数据集管理)
5. [报表设计器](#5-报表设计器)
6. [报表渲染与预览](#6-报表渲染与预览)
7. [报表导出](#7-报表导出)
8. [BI 仪表盘](#8-bi-仪表盘)
9. [图表编辑器](#9-图表编辑器)
10. [查询缓存](#10-查询缓存)
11. [前端功能可用性](#11-前端功能可用性)
12. [系统集成与兼容性](#12-系统集成与兼容性)
13. [测试用例索引](#13-测试用例索引)

---

## 1. 系统概述

### 1.1 技术栈

| 层级 | 技术 |
|------|------|
| 后端 | Go 1.22+, Gin, GORM, JWT, Redis (可选) |
| 前端 | Vue 3, TypeScript, Vite, Element Plus, Pinia |
| 可视化 | ECharts, Monaco Editor, Canvas API |
| 基础设施 | MySQL, Redis, Docker/Docker Compose |

### 1.2 核心能力模块

- **认证授权**: JWT Token 认证、租户隔离
- **数据源管理**: 多数据源配置、连接测试、元数据查询、SSH 隧道
- **数据集管理**: SQL/API 数据集、计算字段、字段配置、查询安全控制
- **报表设计器**: Canvas 设计器、单元格绑定、表达式编辑器
- **报表渲染与预览**: 数据渲染、分页、打印预览
- **报表导出**: PDF/Excel/Word/Image 导出
- **BI 仪表盘**: 组件拖拽、数据绑定、实时预览
- **图表编辑器**: ECharts 集成、多种图表类型、实时预览

---

## 2. 认证与授权

### 2.1 JWT 认证 (auth-jwt)

#### REQ-AUTH-001: JWT Token 验证
系统必须对所有受保护的 API 和 UI 路由验证 JWT 访问令牌。

| 场景 | 预期行为 |
|------|----------|
| 有效 Token 访问 | 请求被授权，用户身份可用于处理程序 |
| 健康检查端点 | `/health` 端点绕过 JWT 验证，返回数据库和服务状态 |
| 无效 Token 拒绝 | 无效或过期的 JWT 返回 401 Unauthorized |

#### REQ-AUTH-002: Claim 映射
系统必须将 JWT claims 映射到用户 ID、角色列表和租户 ID。

| 场景 | 预期行为 |
|------|----------|
| 角色和租户解析 | JWT 包含角色和租户 claims 时，后端解析角色和租户上下文 |
| 用户身份提取 | 请求包含有效 JWT 时，用户身份（userId, username, tenantId）可通过 context 获取 |

#### REQ-AUTH-003: Token 生成
系统必须为认证用户生成包含用户 claims 的 JWT 访问令牌。

| 场景 | 预期行为 |
|------|----------|
| 登录时生成 Token | 用户成功登录后，返回包含用户 ID、角色列表、租户 ID claims 的 JWT |
| Token 载荷结构 | JWT Token 包含 userId、username、roles、tenantId 和标准 claims (exp, iat, iss) |

#### REQ-AUTH-004: 密码哈希
系统必须使用 bcrypt 安全地哈希用户密码。

| 场景 | 预期行为 |
|------|----------|
| 创建用户时哈希密码 | 创建新用户或更新密码时，使用 bcrypt 哈希后再保存 |
| 登录时验证密码 | 用户尝试登录时，使用 bcrypt 比较提供的密码与存储的哈希 |

---

## 3. 数据源管理

### 3.1 数据源 CRUD (datasource-management)

#### REQ-DS-001: 数据源 CRUD 操作
后端必须允许授权用户创建、更新、列出和删除数据源定义。

| 场景 | 预期行为 |
|------|----------|
| 创建数据源 | 用户提交有效数据源定义时，数据源被存储并可用于报表选择 |
| 列出数据源 | 用户请求数据源列表时，返回用户租户的所有数据源 |
| 更新数据源 | 用户更新数据源时，更改被持久化并返回更新后的数据源 |
| 删除数据源 | 用户删除数据源时，数据源被软删除，不再出现在列表中 |

#### REQ-DS-002: 数据源连接测试
后端必须提供数据源连接测试功能。

| 场景 | 预期行为 |
|------|----------|
| 测试数据源连接 | 用户触发连接测试时，返回成功或诊断错误 |
| 无效凭据测试 | 使用无效凭据测试时，返回包含诊断信息的错误 |

#### REQ-DS-003: 数据源元数据查询
后端必须提供数据源元数据查询能力。

| 场景 | 预期行为 |
|------|----------|
| 列出表 | 用户请求数据源的表列表时，返回数据库中的所有基表 |
| 列出字段 | 用户请求表的字段列表时，返回字段名称、类型和元数据 |

#### REQ-DS-004: 租户隔离
系统必须确保数据源访问按租户范围限定。

| 场景 | 预期行为 |
|------|----------|
| 跨租户数据源保护 | 用户尝试访问其他租户的数据源时，请求被 403 Forbidden 拒绝 |
| 按租户查询 | 用户查询数据源列表时，仅返回用户租户的数据源 |

#### REQ-DS-005: 数据源模型
系统必须定义包含连接和元数据字段的数据源模型。

| 场景 | 预期行为 |
|------|----------|
| 数据源结构 | 创建或更新数据源时，模型包含 id、name、type、host、port、database、username、password、tenantId、timestamps |
| 密码字段安全 | 数据源序列化为 JSON 时，密码字段从响应中排除 |

#### REQ-DS-006: 登录 API
后端必须提供登录端点用于用户认证。

| 场景 | 预期行为 |
|------|----------|
| 成功登录 | 用户提交有效用户名和密码时，返回 JWT Token 和用户信息 |
| 登录失败 | 用户提交无效凭据时，返回 401 Unauthorized |

#### REQ-DS-007: 登出 API
后端必须提供登出端点用于用户取消认证。

| 场景 | 预期行为 |
|------|----------|
| Token 失效登出 | 用户调用登出端点时，会话 Token 被失效且无法重用 |
| 无会话登出 | 无有效 Token 调用登出时，返回适当的错误响应 |

#### REQ-DS-008: 数据集元数据查询
后端必须提供可视化数据集的元数据查询能力。

| 场景 | 预期行为 |
|------|----------|
| 查询数据集表和字段 | 用户请求数据集元数据时，返回数据集 ID、名称、类型、维度列表（名称、显示名称、数据类型）、度量列表（名称、显示名称、数据类型）、是否可分组/可聚合标识 |
| 查询数据集计算字段 | 用户请求包含计算字段的数据集元数据时，单独返回计算字段，包含表达式和维度/度量类型 |
| 跨验证数据源和数据集访问 | 用户查询数据集元数据时，验证用户对数据集和底层数据源的访问权限 |

#### REQ-DS-009: 数据源组织操作
系统必须在租户范围授权下提供数据源复制、移动和重命名操作。

| 场景 | 预期行为 |
|------|----------|
| 复制数据源 | 授权用户在同一租户内触发数据源复制时，创建具有重复连接设置的新数据源条目，并分配新唯一标识符 |
| 移动数据源 | 授权用户将数据源移动到另一个文件夹/位置命名空间时，更新数据源位置元数据，保持相同租户范围访问 |
| 重命名数据源 | 授权用户使用有效目标名称重命名数据源时，更新数据源显示名称，不破坏通过数据源 ID 的现有引用 |

#### REQ-DS-010: 数据源搜索能力
系统必须支持数据源列表的关键字搜索。

| 场景 | 预期行为 |
|------|----------|
| 按关键字搜索数据源 | 用户使用搜索关键字查询数据源列表时，返回匹配名称或配置的可搜索字段的租户范围数据源结果 |
| 空搜索关键字 | 用户不使用关键字查询数据源列表时，返回默认的租户范围数据源列表行为 |

#### REQ-DS-011: 数据源元数据描述检索
系统必须在数据源支持描述/注释自省时返回表和字段描述元数据。

| 场景 | 预期行为 |
|------|----------|
| 检索表描述 | 用户从支持的数据源请求表元数据时，在响应中包含表描述/注释字段（如可用） |
| 检索字段描述 | 用户从支持的数据源表请求字段元数据时，在响应中包含字段描述/注释字段（如可用） |

#### REQ-DS-012: 数据源 SSH 隧道连接
系统必须支持通过 SSH 隧道设置的数据源连接。

| 场景 | 预期行为 |
|------|----------|
| SSH 隧道密码认证 | 用户配置带有 SSH 隧道和密码模式的数据源时，验证所需的 SSH 主机、端口、用户名和密码字段，数据源连接测试使用 SSH 隧道到达目标数据源 |
| SSH 隧道密钥认证 | 用户配置带有 SSH 隧道和密钥模式的数据源时，验证所需的 SSH 主机、端口、用户名和私钥字段，可选的密码短语用于私钥解密 |

#### REQ-DS-013: 数据源运行时连接控制
系统必须支持数据源的连接数和查询超时运行时控制。

| 场景 | 预期行为 |
|------|----------|
| 设置最大连接数 | 用户在允许范围内设置数据源最大连接数时，持久化配置并将其应用于数据源 DB 客户端设置 |
| 设置查询超时 | 用户在允许范围内设置数据源查询超时时，持久化配置并在数据源查询和测试期间应用超时 |

#### REQ-DS-014: 数据源连接器配置文件验证
系统必须根据连接器类型配置文件验证数据源配置。

| 场景 | 预期行为 |
|------|----------|
| 验证支持的数据源类型配置文件 | 用户创建或更新支持类型的数据源时，验证类型特定的必需字段，拒绝带有诊断的无效配置 |
| 拒绝不支持的数据源配置文件 | 用户提交当前配置文件注册表中未启用或不支持的数据源类型时，使用显式不支持的类型错误拒绝请求 |

---

## 4. 数据集管理

### 4.1 数据集 CRUD (dataset-management)

#### REQ-DM-001: 数据集 CRUD 操作
后端必须允许授权用户创建、更新、列出和删除数据集定义。

| 场景 | 预期行为 |
|------|----------|
| 创建基于 SQL 的数据集 | 用户提交带有 SQL 查询类型的数据集定义时，使用 SQL 查询和数据源 ID 存储数据集，自动从 SQL 查询结果提取字段 |
| 创建基于 API 的数据集 | 用户提交带有 API 数据源类型的数据集定义时，使用 API 端点 URL 和 HTTP 方法存储数据集，自动从 API 响应提取字段 |
| 创建文件导入数据集 | 用户提交带有文件导入（Excel、CSV）的数据集定义时，使用文件引用存储数据集，自动从文件头提取字段 |
| 列出数据集 | 用户请求数据集列表时，返回用户租户的所有数据集，每个包含名称、类型、数据源名称、字段数和时间戳 |
| 更新数据集 | 用户更新数据集时，持久化更改，如果查询或源更改则重新提取字段 |
| 删除数据集 | 用户删除数据集时，软删除数据集，使用此数据集的报表、仪表盘和图表显示引用错误 |
| 数据集预览 | 用户请求数据集预览时，执行数据集查询或从源获取数据，返回前 100 行数据和列名/数据类型 |

#### REQ-DM-002: 数据集字段配置
前端和后端必须支持配置数据集字段，包括名称、类型（维度/度量）、数据类型、排序顺序和分组。

| 场景 | 预期行为 |
|------|----------|
| 配置字段为维度 | 用户选择数据集字段时，可将字段类型设置为"维度"，用于分类数据（分组、过滤），出现在可视化组件的维度列表中 |
| 配置字段为度量 | 用户选择数据集字段时，可将字段类型设置为"度量"，用于数值数据（聚合、计算），出现在可视化组件的度量列表中 |
| 设置字段数据类型 | 用户选择数据集字段时，可设置字段数据类型（string、number、date、boolean），用于类型验证和格式化 |
| 配置字段排序顺序 | 用户选择数据集字段时，可设置默认排序顺序（asc、desc、none），查询数据集时应用排序顺序 |
| 配置字段分组 | 用户选择维度字段时，可启用分组，图表中使用此字段时数据按此字段分组，度量按组聚合 |
| 配置字段显示名称 | 用户选择数据集字段时，可设置显示名称（别名），在可视化组件 UI 中显示代替原始字段名 |

#### REQ-DM-003: 数据集租户隔离
系统必须确保数据集访问按租户范围限定。

| 场景 | 预期行为 |
|------|----------|
| 跨租户数据集保护 | 用户尝试访问其他租户的数据集时，请求被 403 Forbidden 拒绝 |
| 按租户查询 | 用户查询数据集列表时，仅返回用户租户的数据集 |
| 数据查询中的租户隔离 | 用户从数据集查询数据时，在底层数据源上强制执行租户隔离 |

#### REQ-DM-004: 模式驱动的数据集预览渲染
前端必须使用模式感知映射而不是固定字段键来渲染数据集预览。

| 场景 | 预期行为 |
|------|----------|
| 为非区域/销售模式渲染预览 | 预览载荷字段与固定演示键不同时，从可用模式和数据派生显示映射，无需硬编码假设即可渲染有意义的输出 |
| 图表映射不可用时的回退 | 预览数据未提供合适的图表维度/度量对时，回退到安全预览呈现，用户收到关于当前预览模式的清晰反馈 |

#### REQ-DM-005: 数据集查询和预览失败透明性
系统必须为受保护的数据集预览和查询路径提供稳定且可操作的失败响应。

| 场景 | 预期行为 |
|------|----------|
| 带有可操作消息的预览失败 | 由于验证或执行约束导致预览执行失败时，返回可读的错误消息和失败类型，客户端可以呈现可恢复的指导 |
| 带有确定性结构的查询失败 | 由于配置的保护措施导致查询执行失败时，返回确定性的响应结构供客户端处理，错误返回前仍强制执行租户隔离和授权检查 |

### 4.2 数据集 API (dataset-api)

#### REQ-DA-001: 数据集 CRUD API
后端必须在 `/api/v1/datasets` 提供 REST API 用于数据集 CRUD 操作。

| 场景 | 预期行为 |
|------|----------|
| 创建数据集 API | 授权用户 POST `/api/v1/datasets` 带有数据集定义时，验证数据源 ID 属于用户租户，验证 SQL 查询或 API 配置，创建数据集记录，从查询/API 响应提取字段，返回带有字段列表的创建数据集，状态码 201 |
| 列出数据集 API | 授权用户 GET `/api/v1/datasets` 时，返回用户租户的所有数据集，每个包含 id、name、type、datasourceName、fieldCount、createdAt、updatedAt，结果分页，状态码 200 |
| 获取数据集 API | 授权用户 GET `/api/v1/datasets/{id}` 时，返回带有完整详细信息的数据集，包括数据源、字段、配置，状态码 200；数据集不存在或属于其他租户时，状态码 404 |
| 更新数据集 API | 授权用户 PUT `/api/v1/datasets/{id}` 带有更新数据集时，验证数据集属于用户租户，更新数据集记录，如果查询更改则重新提取字段，返回更新数据集，状态码 200 |
| 删除数据集 API | 授权用户 DELETE `/api/v1/datasets/{id}` 时，验证数据集属于用户租户，软删除数据集记录，返回成功消息，状态码 200 |
| 带有引用的删除数据集 | 数据集被报表、仪表盘或图表使用时，返回 409 Conflict 带有引用列表，提供级联删除或中止选项 |

#### REQ-DA-002: 数据集查询 API
后端必须在 `/api/v1/datasets/{id}/data` 提供查询数据集数据的 API。

| 场景 | 预期行为 |
|------|----------|
| 查询数据集数据 API | 授权用户 POST `/api/v1/datasets/{id}/data` 带有查询参数时，验证数据集属于用户租户，执行 SQL 查询或获取 API 数据，应用计算字段表达式，应用过滤、排序和分页，返回数据数组和元数据（总数、执行时间），状态码 200 |
| 带过滤查询 | 请求包含过滤数组时，将每个过滤器应用于查询，支持运算符（eq、neq、gt、gte、lt、lte、like、in），过滤适用于原始字段和计算字段 |
| 带排序查询 | 请求包含 sortBy 和 sortOrder 参数时，将排序应用于查询，可应用于多个字段，适用于原始字段和计算字段 |
| 带分页查询 | 请求包含 page 和 pageSize 参数时，应用 LIMIT 和 OFFSET，返回请求页面的数据数组和分页控件的总数 |
| 带字段选择查询 | 请求包含 fields 参数时，在查询中仅选择指定字段，结果仅包含选定字段，宽表性能提升 |

#### REQ-DA-003: 数据集预览 API
后端必须在 `/api/v1/datasets/{id}/preview` 提供预览数据集样本数据的 API。

| 场景 | 预期行为 |
|------|----------|
| 预览数据集 API | 授权用户 GET `/api/v1/datasets/{id}/preview` 时，验证数据集属于用户租户，使用 LIMIT 100 执行查询，返回前 100 行、列名和数据类型、查询执行时间，状态码 200 |
| 带过滤预览 | 请求包含过滤参数时，在 LIMIT 之前应用过滤，返回过滤的样本数据，用户可在保存前预览过滤数据 |

#### REQ-DA-004: 数据集字段管理 API
后端必须在 `/api/v1/datasets/{id}/fields` 提供管理数据集字段的 API。

| 场景 | 预期行为 |
|------|----------|
| 列出数据集字段 API | 授权用户 GET `/api/v1/datasets/{id}/fields` 时，返回数据集的所有字段，每个包含 name、displayName、type（维度/度量）、dataType、isComputed、isGroupable、isSortable，按维度和度量分组，状态码 200 |
| 创建计算字段 API | 授权用户 POST `/api/v1/datasets/{id}/fields` 带有字段定义时，验证字段表达式语法，创建计算字段记录，标记为计算字段，返回创建的字段，状态码 201 |
| 更新字段配置 API | 授权用户 PUT `/api/v1/datasets/{id}/fields/{fieldId}` 带有更新字段时，更新字段配置，允许更改 displayName、type、dataType、排序顺序、分组，不允许更改原始字段名，返回更新的字段，状态码 200 |
| 删除计算字段 API | 授权用户 DELETE `/api/v1/datasets/{id}/fields/{fieldId}` 时，验证字段是计算字段，不允许删除原始字段，删除计算字段记录，返回成功消息，状态码 200 |

#### REQ-DA-005: 数据集验证 API
后端必须在 `/api/v1/datasets/validate` 提供验证数据集配置的 API。

| 场景 | 预期行为 |
|------|----------|
| 验证 SQL 查询 API | 授权用户 POST `/api/v1/datasets/validate` 带有 SQL 查询和数据源 ID 时，验证数据源属于用户租户，执行 EXPLAIN 查询，返回验证结果（有效/无效）、估计执行时间、错误消息（如无效），状态码 200 |
| 验证 API 端点 API | 授权用户 POST `/api/v1/datasets/validate` 带有 API 配置时，向 API 端点发送测试请求，验证响应结构，返回验证结果和样本响应数据，状态码 200 |
| 验证计算字段表达式 API | 授权用户 POST `/api/v1/datasets/validate` 带有表达式和数据集 ID 时，验证表达式语法、字段引用、函数使用，返回带有错误的验证结果，状态码 200 |

#### REQ-DA-006: 批量字段更新 API
后端必须在 `PATCH /api/v1/datasets/{id}/fields` 提供批量字段更新端点。

| 场景 | 预期行为 |
|------|----------|
| 带有部分失败的批量更新字段 | 授权用户提交批量字段更新且一个或多个项目验证失败时，仅应用有效更新，返回更新的字段 ID 和失败项目的字段级错误详情，响应契约对前端重试是确定性的 |
| 拒绝跨租户数据集的批量更新 | 授权用户发送用户租户范围外数据集的批量更新请求时，拒绝请求，不持久化任何字段更新 |

#### REQ-DA-007: 查询和预览护栏错误
后端必须为受保护的查询和预览路径返回显式验证和执行边界错误响应。

| 场景 | 预期行为 |
|------|----------|
| 为不安全查询载荷返回验证错误 | 请求载荷违反 SQL 安全验证规则时，返回带有可操作消息的验证错误响应，不尝试查询执行 |
| 返回边界执行错误 | 数据集查询或预览超过配置的执行约束时，返回一致的失败响应格式，前端可区分执行边界失败和传输失败 |

#### REQ-DA-008: 数据集查询契约一致性
系统必须在 `/api/v1/datasets/{id}/data` 强制执行单一规范契约用于数据集查询执行。

| 场景 | 预期行为 |
|------|----------|
| 规范查询请求成功 | 授权调用方发送遵循规范方法和载荷契约的请求时，后端接受请求并执行查询逻辑，响应信封以确定性结构返回供前端使用 |
| 非规范请求被带诊断拒绝 | 调用方使用不支持的方法或格式错误的数据集查询载荷时，后端使用 4xx 响应拒绝请求，响应包含供调用方纠正的可操作诊断消息 |

#### REQ-DA-009: 报表设计器查询兼容性
报表设计器查询预览工作流必须使用规范数据集查询契约，不依赖回退传输行为。

| 场景 | 预期行为 |
|------|----------|
| 报表预览通过规范契约检索数据 | 用户在报表设计器中为数据集绑定单元格触发数据预览时，前端使用规范契约调用数据集查询端点，预览面板渲染返回数据或显示后端诊断消息 |

### 4.3 计算字段 (dataset-computed-fields)

#### REQ-CF-001: 计算字段创建
前端和后端必须支持创建带有引用数据集字段、函数和算术运算符表达式的计算字段。

| 场景 | 预期行为 |
|------|----------|
| 带字段引用创建计算字段 | 用户在数据集字段编辑器中创建新字段时，可点击现有数据集字段引用它们，引用字段添加到字段表达式，表达式编辑器显示用方括号包裹的字段名 [field_name] |
| 带算术运算符创建计算字段 | 用户在数据集字段编辑器中创建新字段时，可添加算术运算符（+、-、*、/）到表达式，可手动输入或通过运算符按钮添加，表达式验证检查有效运算符语法 |
| 带数据库函数创建计算字段 | 用户在数据集字段编辑器中创建新字段时，可访问与数据集数据库兼容的函数库，包括聚合（SUM、AVG、COUNT、MAX、MIN）、字符串（CONCAT、SUBSTRING、LENGTH）、日期（DATE_FORMAT、DATE_ADD、DATEDIFF）、数学（ROUND、CEIL、FLOOR、ABS），显示函数签名和参数 |
| 带复杂表达式创建计算字段 | 用户创建带有表达式 `ROUND([price] * [quantity], 2)` 的字段时，表达式引用 price 和 quantity 字段，使用带有精度参数的 ROUND 函数，使用乘法运算符，查询数据集时计算字段被计算 |

#### REQ-CF-002: 计算字段类型配置
前端和后端必须支持根据表达式结果配置计算字段类型（维度/度量）和数据类型。

| 场景 | 预期行为 |
|------|----------|
| 设置计算字段为维度 | 用户创建计算字段时，可选择字段类型为"维度"，用于分类数据，出现在可视化的维度列表中 |
| 设置计算字段为度量 | 用户创建计算字段时，可选择字段类型为"度量"，用于数值数据，出现在可视化的度量列表中，可在可视化中聚合 |
| 配置计算字段数据类型 | 用户创建计算字段时，可手动设置数据类型（string、number、date），用于类型验证 |
| 自动检测计算字段数据类型 | 用户为计算字段启用自动检测时，在样本数据上执行表达式，从结果推断数据类型（string、number、date），自动设置字段数据类型，用户可覆盖自动检测的类型 |

#### REQ-CF-003: 计算字段表达式编辑器
前端必须提供用于创建和编辑计算字段表达式的富表达式编辑器。

| 场景 | 预期行为 |
|------|----------|
| 带字段引用的表达式编辑器 | 用户打开计算字段表达式编辑器时，左侧显示字段列表，点击字段在光标位置添加到表达式，字段显示其数据类型 |
| 带函数库的表达式编辑器 | 用户打开计算字段表达式编辑器时，右侧显示函数库，按类别组织（聚合、字符串、日期、数学），点击函数显示签名并添加到表达式 |
| 带语法高亮的表达式编辑器 | 用户在表达式编辑器中输入时，字段以一种颜色高亮，函数以另一种颜色高亮，运算符和字面量高亮，无效语法用红色下划线标记 |
| 带验证的表达式编辑器 | 用户在表达式编辑器中输入时，实时验证检查语法，验证错误显示在编辑器下方，错误包括预期和实际标记，可点击验证按钮检查整个表达式 |
| 带自动完成的表达式编辑器 | 用户输入字段名前缀时，自动完成显示匹配字段，从自动完成选择插入字段引用；用户输入函数名前缀时，自动完成显示匹配函数，选择插入带有参数的函数调用 |

#### REQ-CF-004: 计算字段表达式执行
后端必须在查询数据集数据时执行计算字段表达式。

| 场景 | 预期行为 |
|------|----------|
| 在 SQL 查询中执行计算字段 | 数据集包含带有表达式的计算字段时，后端将表达式包装在 SQL SELECT 子句中，用实际列名替换字段引用，执行带有计算字段表达式的查询，结果包含计算字段值 |
| 为 API 数据集执行计算字段 | 数据集包含带有表达式的计算字段时，后端从 API 获取数据，在内存中对每行应用表达式，结果包含计算字段值 |
| 执行带有嵌套引用的计算字段 | 计算字段表达式引用另一个计算字段时，后端解析嵌套字段引用，先计算依赖字段，结果包含所有计算字段值 |
| 处理计算字段错误 | 某行的计算字段表达式评估失败时，系统记录带有行标识符的错误，为该字段值返回 NULL，继续处理其他行 |

#### REQ-CF-005: 计算字段缓存
后端必须缓存计算字段表达式以提高查询性能。

| 场景 | 预期行为 |
|------|----------|
| 缓存计算字段 SQL | 创建或更新计算字段时，后端生成并缓存 SQL SELECT 表达式，缓存的表达式用于后续查询，字段修改时缓存失效 |
| 为 API 数据集缓存计算字段 | 为 API 数据集创建计算字段时，后端缓存编译的表达式评估器，缓存的评估器用于后续查询，字段修改时缓存失效 |

### 4.4 字段批量与分组 (dataset-field-batch-and-grouping)

#### REQ-FBG-001: 批量字段管理
数据集编辑器必须支持字段配置的批量更新，包括字段类型、显示元数据和排序属性。

| 场景 | 预期行为 |
|------|----------|
| 批量更新多个字段 | 用户在批量管理中选择多个字段并提交更新时，根据字段规则验证每个更新，在一个批量操作中应用有效更改，返回维度和度量的更新字段状态 |
| 带无效字段规则的批量更新 | 批量请求包含无效字段配置时，拒绝无效更新并带有字段级错误详情，不静默覆盖未受影响的字段属性，用户可纠正并重试而无需重新加载页面 |

#### REQ-FBG-002: 分组字段创建和行为
数据集编辑器必须提供专用入口来创建分组字段并通过维度兼容配置应用分组行为。

| 场景 | 预期行为 |
|------|----------|
| 从编辑器创建分组字段 | 用户点击新建分组字段并提交有效配置时，创建可分组字段配置，字段出现在维度侧字段列表中带有分组元数据，分组字段可用于下游查询和可视化绑定 |
| 在查询路径中使用分组字段 | 使用启用分组的字段执行数据集查询时，在度量聚合之前应用分组语义，返回带有一致字段别名的分组结果集 |

#### REQ-FBG-003: 分组和批量验证契约
后端必须为批量和分组操作提供验证和响应契约，对于非破坏性前端演进是安全的。

| 场景 | 预期行为 |
|------|----------|
| 验证分组配置 | 用户提交带有不支持表达式或类型的分组规则时，返回带有可操作消息的验证错误，不持久化无效分组配置 |
| 现有数据集的向后兼容性 | 加载没有批量/分组元数据的现有数据集时，返回默认兼容的字段元数据，现有保存和预览行为保持功能，无迁移阻碍 |

#### REQ-FBG-004: 批量更新交互可靠性
数据集编辑器必须为批量字段更新提供可靠的交互反馈。

| 场景 | 预期行为 |
|------|----------|
| 无选择批量提交 | 用户在没有选定字段的情况下触发批量更新时，阻止请求提交，显示清晰指导先选择字段 |
| 批量更新部分失败反馈 | 批量更新响应包含成功和字段级失败时，呈现失败字段详情而不丢弃成功更新，刷新字段元数据以匹配持久化的后端状态 |

#### REQ-FBG-005: 批量字段更新响应契约
后端必须为数据集批量字段更新提供字段级响应详情。

| 场景 | 预期行为 |
|------|----------|
| 返回每字段更新结果 | 处理批量更新请求时，响应包含成功更新的字段 ID 列表，包含被拒绝更新的每字段错误对象 |
| 保持未受影响的字段属性稳定 | 批量更新载荷省略字段属性时，保持现有属性值不变，响应反映最终持久化状态，无隐式重置 |

### 4.5 查询安全控制 (dataset-query-safety-controls)

#### REQ-QSC-001: SQL 安全验证
后端必须在预览或查询执行之前验证数据集 SQL，并拒绝不安全的语句。

| 场景 | 预期行为 |
|------|----------|
| 拒绝危险的 SQL 语句 | 用户为包含不允许的 SQL 操作的数据集提交预览或查询请求时，在执行之前拒绝请求，响应包含被拒绝操作的机器可读验证错误 |
| 拒绝过度的查询复杂性 | 用户提交超过配置复杂性阈值的 SQL 预览或查询请求时，不触及数据源执行而拒绝请求，响应识别复杂性相关的验证失败 |

#### REQ-QSC-002: 数据集查询和预览执行边界
后端必须为数据集预览和数据查询操作强制执行边界。

| 场景 | 预期行为 |
|------|----------|
| 强制查询超时 | 数据集查询或预览执行超过配置的超时时，中止执行并返回超时错误响应，响应对于 UI 重试处理是安全的 |
| 强制边界分页 | 数据集查询请求包含缺失或超出范围的分页输入时，应用默认和最大分页限制，响应包含应用的 page 和 pageSize 值 |

### 4.6 数据集集成 (dataset-integration)

#### REQ-DI-001: 可视化组件的数据集元数据 API
后端必须为可视化组件（报表设计器、仪表盘、图表编辑器）提供 API 查询数据集元数据，包括维度和度量。

| 场景 | 预期行为 |
|------|----------|
| 获取数据集维度 API | 可视化组件请求 `/api/v1/datasets/{id}/dimensions` 时，返回维度字段列表，每个包含 name、displayName、dataType、isGroupable，包含标记为维度的计算字段，状态码 200 |
| 获取数据集度量 API | 可视化组件请求 `/api/v1/datasets/{id}/measures` 时，返回度量字段列表，每个包含 name、displayName、dataType、isAggregateable，包含标记为度量的计算字段，状态码 200 |
| 获取数据集模式 API | 可视化组件请求 `/api/v1/datasets/{id}/schema` 时，返回完整数据集模式，包括数据源信息、维度列表、度量列表、带有表达式的计算字段，状态码 200 |

#### REQ-DI-002: 报表设计器数据集集成
报表设计器必须支持将报表单元格绑定到数据集维度和度量，而不是直接的数据源/SQL。

| 场景 | 预期行为 |
|------|----------|
| 在报表设计器中选择数据集 | 用户打开报表设计器时，可从下拉菜单中选择数据集而不是数据源，下拉菜单显示用户租户的所有数据集，数据集选择填充维度和度量列表，维度和度量出现在数据绑定面板中 |
| 将单元格绑定到数据集维度 | 用户在报表设计器中选择单元格时，可从下拉菜单中选择数据集维度，可选择配置分组（GROUP BY），单元格绑定包含数据集 ID 和维度字段名，维度字段以显示名称显示，单元格类型更改为 `dataset-dimension` |
| 将单元格绑定到数据集度量 | 用户在报表设计器中选择单元格时，可从下拉菜单中选择数据集度量，可选择聚合函数（SUM、AVG、COUNT、MAX、MIN、none），单元格绑定包含数据集 ID 和度量字段名，度量字段以显示名称显示，单元格类型更改为 `dataset-measure` |
| 绑定计算字段 | 用户在报表设计器中选择单元格时，可从下拉菜单中选择计算字段（维度或度量），计算字段以显示名称显示，单元格绑定包含计算字段名，报表渲染时计算计算字段值 |
| 保存带有数据集绑定的报表 | 用户保存带有数据集绑定的报表时，存储包含数据集 ID 和字段名的报表配置，不存储 SQL 查询，存储聚合和分组配置，报表配置通过 ID 引用数据集 |
| 使用数据集数据渲染报表 | 用户预览或渲染带有数据集绑定的报表时，后端加载数据集配置，从数据集 SQL 和字段绑定构造 SQL 查询，应用计算字段表达式，应用分组和聚合，执行查询并用数据填充单元格，报表以实际数据渲染 |
| 迁移现有报表到数据集 | 用户打开带有直接 SQL 绑定的现有报表时，系统提供迁移选项转换为数据集，提取数据源、表和字段信息，提示用户创建数据集或选择现有数据集，用户可将报表迁移为使用数据集 |

#### REQ-DI-003: 仪表盘数据集集成
仪表盘设计器必须支持将仪表盘小部件绑定到数据集维度和度量。

| 场景 | 预期行为 |
|------|----------|
| 在仪表盘设计器中选择数据集 | 用户向仪表盘添加小部件时，可从下拉菜单中选择数据集，下拉菜单显示用户租户的所有数据集，数据集选择填充维度和度量列表 |
| 将图表绑定到数据集维度 | 用户配置图表 X 轴或类别维度时，可从下拉菜单中选择数据集维度，可选择配置分组，维度以显示名称显示，图表配置引用数据集 ID 和维度名 |
| 将图表绑定到数据集度量 | 用户配置图表 Y 轴或值度量时，可从下拉菜单中选择数据集度量，可选择聚合函数，可选择多个度量用于多系列图表，度量以显示名称显示，图表配置引用数据集 ID 和度量名 |
| 保存带有数据集绑定的仪表盘 | 用户保存带有数据集绑定的仪表盘时，存储带有数据集 ID 和字段名的小部件配置，小部件配置通过 ID 引用数据集，存储聚合和分组设置 |
| 使用数据集数据渲染仪表盘 | 渲染仪表盘时，后端为每个小部件加载数据集配置，为每个小部件查询数据集数据，应用计算字段、分组、聚合，向后端返回数据，小部件以实际数据渲染 |

#### REQ-DI-004: 图表编辑器数据集集成
图表编辑器必须支持使用数据集作为图表数据源。

| 场景 | 预期行为 |
|------|----------|
| 在图表编辑器中选择数据集 | 用户打开图表编辑器时，可选择数据集作为数据源类型，可从下拉菜单中选择特定数据集，数据集选择显示可用维度和度量，维度和度量在单独列表中组织 |
| 将图表维度映射到数据集维度 | 用户配置图表 X 轴或类别时，从列表中选择数据集维度，维度显示名称在配置中显示，维度类型（string、date、number）显示，如果维度可分组则可启用分组 |
| 将图表度量映射到数据集度量 | 用户配置图表 Y 轴或值时，从列表中选择数据集度量，度量显示名称在配置中显示，可选择聚合函数，可为系列添加多个度量，每个系列引用数据集度量 |
| 使用数据集数据预览图表 | 用户在图表编辑器中预览图表时，后端查询数据集数据，应用计算字段、分组、聚合，以图表预期格式返回数据，前端以实际数据渲染图表，配置更改时实时更新 |
| 保存带有数据集引用的图表配置 | 用户保存图表配置时，在图表配置中存储数据集 ID，存储维度和度量引用，存储聚合和分组设置，图表配置可用更新的数据集数据重用 |
| 处理数据集模式更改 | 数据集模式更新（字段添加/删除/重命名）时，验证使用数据集的图表配置，使用删除字段的图表在编辑器中显示错误，使用重命名字段的图表更新为新字段名，系统记录图表所有者的模式更改通知 |

### 4.7 数据集编辑器 UI 工作流 (dataset-editor-ui-workflow)

#### REQ-DEU-001: 数据集编辑器工作流布局
数据集编辑器必须提供面向工作流的布局，包括数据源区域、字段管理区域和顶部操作区域。

| 场景 | 预期行为 |
|------|----------|
| 打开数据集编辑器 | 用户打开数据集创建或编辑页面时，页面显示数据源和表选择区域，显示按维度和度量组织的字段管理区域，显示包括保存、保存并返回、刷新数据的顶部操作 |

#### REQ-DEU-002: 保存操作语义
数据集编辑器必须为保存和保存并返回操作实现不同的语义。

| 场景 | 预期行为 |
|------|----------|
| 保存当前数据集 | 用户点击保存且验证通过时，持久化数据集和字段更改，用户保留在当前编辑器页面，系统显示成功反馈并更新本地页面状态 |
| 保存并返回列表 | 用户点击保存并返回且验证通过时，持久化数据集和字段更改，系统导航用户回数据集列表页面，系统为列表刷新保留成功保存结果 |
| 保存失败处理 | 用户触发保存或保存并返回且后端返回错误时，用户保留在当前页面，保留未保存的表单上下文，系统显示可读的错误反馈 |

#### REQ-DEU-003: 标签页和刷新状态流程
数据集编辑器必须为数据预览、批量管理和刷新数据操作提供可预测的状态转换。

| 场景 | 预期行为 |
|------|----------|
| 从预览切换到批量管理 | 用户从数据预览标签页切换到批量管理标签页时，保持当前数据集上下文，为批量操作加载或重用字段元数据，一致地显示加载和错误状态 |
| 刷新数据集数据 | 用户点击刷新数据时，为当前数据集重新加载预览数据和相关元数据，请求进行中时使用加载状态，完成后显示成功或错误反馈 |

#### REQ-DEU-004: 数据集编辑器状态一致性
数据集编辑器必须在保存、预览、刷新和标签页转换之间保留有效的编辑上下文。

| 场景 | 预期行为 |
|------|----------|
| 保存失败保持编辑上下文 | 用户触发保存或保存并返回且后端返回失败时，系统保持当前表单状态和选定数据集上下文，系统显示可操作错误反馈而不重置路由 |
| 标签页转换可预测地重用或刷新状态 | 用户在数据预览和批量管理标签页之间切换时，有效时重用已加载状态，在交互之前确定性地刷新缺失状态 |

#### REQ-DEU-005: 数据集编辑器关键路径测试覆盖
前端必须为关键数据集编辑器工作流提供自动化测试。

| 场景 | 预期行为 |
|------|----------|
| 保存和保存并返回行为测试 | 自动化测试执行编辑器保存操作时，测试验证两种保存模式和失败路径的路由/状态行为 |
| 刷新和预览行为测试 | 自动化测试执行刷新和预览操作时，测试验证加载、成功和失败状态处理 |

---

## 5. 报表设计器

### 5.1 报表设计器后端 (report-designer)

#### REQ-RD-001: 报表设计器访问
后端必须为有访问权限的用户提供报表设计器入口路由 `/jmreport/list`。

| 场景 | 预期行为 |
|------|----------|
| 访问报表设计器 | 认证用户访问 `/jmreport/list` 时，报表设计器 UI 可用 |

#### REQ-RD-002: 报表模板 CRUD
后端必须提供用于创建、更新、列出和删除设计器使用的报表模板的 API。

| 场景 | 预期行为 |
|------|----------|
| 更新报表模板 | 用户提交现有报表模板的更新时，模板被持久化，后续视图反映更改 |

#### REQ-RD-003: 报表数据绑定
前端必须允许用户将数据源、表和字段绑定到报表单元格，后端必须用数据库中的实际数据渲染报表。

| 场景 | 预期行为 |
|------|----------|
| 用户创建数据绑定报表 | 用户在报表设计器中选择单元格时，可从可用数据源选择数据源，可从选定数据源选择数据库表，可从选定表选择字段；用户保存带有数据绑定的报表时，报表配置包含数据源 ID、表名和字段名；用户查看报表预览时，后端查询数据源获取数据，后端用数据库中的实际数据渲染报表，前端显示数据填充的单元格 |
| 带参数的报表预览 | 用户打开报表预览时，系统加载报表配置，后端从报表配置中提取所有数据绑定；存在数据绑定时，后端为每个唯一数据源和表组合查询数据库，后端将数据传递给渲染引擎，后端生成带有数据的 HTML，前端显示渲染的报表 |
| 无数据绑定的报表 | 用户创建没有数据绑定的报表时，单元格显示静态文本值；用户保存报表时，静态值被持久化；用户预览报表时，报表显示静态文本值 |

#### REQ-RD-004: 数据源元数据 API
后端必须提供 API 检索数据源元数据，包括表和字段，使报表设计器能够呈现数据绑定选项。

| 场景 | 预期行为 |
|------|----------|
| 加载可用数据源 | 用户打开报表设计器时，系统从 `/datasource/list` 加载可用数据源，用户可看到数据源名称、类型和连接状态 |
| 加载数据源表 | 用户在属性面板中选择数据源时，可请求数据源的表，后端查询数据源数据库获取可用表，后端返回表名列表，用户可从下拉菜单中选择表 |
| 加载表字段 | 用户选择表时，可请求表的字段，后端查询数据库模式获取表，后端返回带有类型的字段名列表，用户可从下拉菜单中选择字段 |

#### REQ-RD-005: 单元格数据绑定配置
前端属性面板必须提供用于配置单元格数据绑定的 UI，包括数据源、表、字段和可选聚合函数。

| 场景 | 预期行为 |
|------|----------|
| 配置文本单元格数据绑定 | 用户在报表设计器中点击单元格时，属性面板显示单元格属性，包含"数据绑定"部分，可从下拉菜单选择数据源，可从下拉菜单选择表（选择数据源前禁用），可从下拉菜单选择字段（选择表前禁用），可选择聚合函数（sum、avg、count、max、min、none），可输入绑定的显示标签，保存单元格或选择另一个单元格时保存配置 |
| 清除数据绑定 | 用户想从单元格移除数据绑定时，可在属性面板中点击"清除数据绑定"按钮，所有数据绑定字段重置为空，单元格类型从 `bound` 更改回 `text`，单元格显示静态文本值而不是数据绑定指示器 |

#### REQ-RD-006: 带数据渲染的报表预览
前端必须提供报表预览页面，调用后端渲染 API 并显示带有实际数据的渲染 HTML。

| 场景 | 预期行为 |
|------|----------|
| 带数据预览报表 | 用户在报表设计器中点击"预览"按钮时，用户导航到预览页面，预览页面从后端加载报表配置，预览页面使用报表 ID 调用 `/api/v1/jmreport/preview` API，后端用数据库中的数据渲染报表，后端返回带有数据填充单元格的 HTML，前端在预览容器中显示渲染的 HTML，用户可在报表中看到数据库的实际数据 |
| 刷新预览数据 | 用户在预览页面中点击"刷新"按钮时，系统重新查询数据库获取最新数据，预览页面重新渲染报表，显示更新的数据 |

#### REQ-RD-007: 带数据绑定的报表持久化
前端和后端必须支持保存和加载包含单元格数据绑定的报表配置。

| 场景 | 预期行为 |
|------|----------|
| 保存带有数据绑定的报表 | 用户在报表设计器中点击"保存"按钮时，系统收集所有单元格配置包括数据绑定，系统构造包含带有数据源、表名和字段名的单元格的报表 JSON 配置，系统将配置发送到 `/api/v1/jmreport/create` 或 `/api/v1/jmreport/update`，后端在 `jimu_report` 表的 `json_str` 列中持久化配置，报表以数据绑定信息保存 |
| 加载带有数据绑定的报表 | 用户从报表列表打开现有报表时，系统加载报表配置，系统解析包括单元格数据绑定的配置，报表设计器用单元格填充画布，带有数据绑定的单元格显示数据源、表和字段信息，属性面板显示当前数据绑定配置，用户可编辑报表或预览 |

#### REQ-RD-008: 报表数据集绑定
前端和后端必须支持将报表单元格绑定到数据集维度和度量。

| 场景 | 预期行为 |
|------|----------|
| 将单元格绑定到数据集维度 | 用户选择单元格并选择数据集作为数据源时，可从可用数据集选择数据集，可从数据集维度列表选择维度，可为维度启用分组（GROUP BY），单元格标记为绑定到数据集维度，单元格显示维度的显示名称 |
| 将单元格绑定到数据集度量 | 用户选择单元格并选择数据集作为数据源时，可从数据集度量列表选择度量，可选择聚合函数（SUM、AVG、COUNT、MAX、MIN、none），单元格标记为绑定到数据集度量，单元格显示度量的显示名称 |
| 保存带有数据集绑定的报表 | 用户保存带有数据集绑定单元格的报表时，系统在报表配置中存储数据集 ID，存储维度/度量字段名，存储聚合和分组配置，不在报表配置中存储 SQL 查询 |
| 使用数据集数据渲染报表 | 用户预览或打印带有数据集绑定的报表时，后端从 ID 加载数据集配置，后端使用数据集的 SQL 或 API 查询数据集数据，后端应用计算字段表达式，后端应用来自单元格绑定的分组和聚合，后端用查询结果填充单元格，报表以实际数据渲染 |
| 迁移现有报表到数据集 | 用户打开带有直接数据源绑定的报表时，系统提供从绑定创建数据集的选项，系统提供选择现有数据集作为替换的选项，用户可选择迁移报表为使用数据集，系统将数据源/字段绑定转换为数据集/字段绑定 |

### 5.2 报表设计器 UI (report-designer-ui)

#### REQ-RDU-001: 基于 Canvas 的报表设计器
系统必须提供基于 Canvas 的报表设计器，允许用户通过拖放和操作单元格在类似 Excel 的界面中设计报表。

| 场景 | 预期行为 |
|------|----------|
| 用户打开空白报表设计器 | 用户创建新报表时，显示空白画布设计器，默认网格大小（100 列 x 50 行），可见标准工具栏（字体、颜色、边框、对齐），右侧可见属性面板 |
| 用户选择单个单元格 | 用户点击单元格时，单元格以选择边框高亮，属性面板显示单元格属性（值、字体、颜色、边框），用户可就地或通过属性面板编辑单元格值 |
| 用户通过拖动选择多个单元格 | 用户在多个单元格上拖动鼠标时，选择区域中的所有单元格被高亮，属性面板显示选择的属性，用户可将样式应用于所有选定单元格 |
| 用户调整列宽 | 用户拖动列标题边框时，列宽实时更改，相邻列相应移动，宽度对齐到网格（8px 增量） |
| 用户调整行高 | 用户拖动行标题边框时，行高实时更改，相邻行相应移动，高度对齐到网格（4px 增量） |
| 用户合并单元格 | 用户选择多个单元格并点击"合并"按钮时，单元格合并为单个单元格，保留左上角单元格的值，合并单元格跨越选定区域，合并操作保存到报表设计 |
| 用户取消合并单元格 | 用户选择合并单元格并点击"取消合并"按钮时，单元格取消合并为原始单元格网格，单元格值保留在左上角单元格，取消合并操作保存到报表设计 |
| 用户应用单元格样式 | 用户选择单元格并应用字体样式（粗体、斜体、大小）时，样式应用于所有选定单元格，样式更改在画布上立即可见，样式更改保存到报表设计 |
| 用户应用单元格边框 | 用户选择单元格并应用边框（上、下、左、右、全部）时，边框应用于所有选定单元格，边框更改在画布上立即可见，边框更改保存到报表设计 |
| 用户应用单元格颜色 | 用户选择单元格并应用背景颜色或文本颜色时，颜色应用于所有选定单元格，颜色更改在画布上立即可见，颜色更改保存到报表设计 |

#### REQ-RDU-002: 单元格数据绑定
系统必须允许用户将单元格绑定到数据源，使报表中的动态数据填充。

| 场景 | 预期行为 |
|------|----------|
| 用户将单元格绑定到数据库字段 | 用户选择单元格并打开数据绑定对话框时，可选择数据源，可选择数据源的表，可选择表的字段，单元格显示字段名作为占位符（例如 `${field_name}`），绑定保存到报表设计 |
| 用户使用表达式绑定单元格 | 用户在数据绑定对话框中输入表达式（例如 `${SUM(field)}`）时，验证表达式语法错误，单元格显示表达式作为占位符，表达式保存到报表设计，表达式语法在 Monaco 编辑器中高亮 |
| 用户移除数据绑定 | 用户为绑定单元格打开数据绑定对话框并点击"清除"时，数据绑定被移除，单元格恢复显示静态值，取消绑定保存到报表设计 |
| 用户测试数据绑定 | 用户在数据绑定对话框中点击"测试"按钮时，系统从数据源获取样本数据，单元格在画布上显示样本值，绑定确认正确工作 |

#### REQ-RDU-003: 表达式编辑器
系统必须提供带有语法高亮和自动完成的表达式编辑器，用于构建复杂数据表达式。

| 场景 | 预期行为 |
|------|----------|
| 用户打开表达式编辑器 | 用户在属性面板中点击表达式编辑器按钮时，在模态对话框中打开 Monaco 编辑器，当前表达式加载到编辑器，表达式语法高亮 |
| 用户使用自动完成输入表达式 | 用户开始输入函数名（例如 "SU"）时，出现自动完成建议（例如 "SUM"、"SUBSTR"、"UPPER"），用户可使用 Tab 或 Enter 从建议中选择，选定的函数插入且光标位于括号内 |
| 用户验证表达式 | 用户在表达式编辑器中点击"验证"按钮时，检查表达式语法，显示验证结果（有效或错误消息），如果有错误则高亮错误位置 |
| 用户保存表达式 | 用户在表达式编辑器中点击"保存"按钮时，表达式保存到单元格绑定，编辑器模态关闭，单元格显示表达式作为占位符 |

#### REQ-RDU-004: 报表保存和加载
系统必须允许用户保存报表设计并加载以进行编辑。

| 场景 | 预期行为 |
|------|----------|
| 用户保存新报表 | 用户为新报表点击"保存"按钮时，提示用户输入报表名称，报表设计通过 API 发送到后端，显示成功消息，分配并存储报表 ID |
| 用户保存现有报表 | 用户为现有报表点击"保存"按钮时，报表设计通过 API 发送到后端，显示成功消息，状态栏出现"已保存"指示器 |
| 用户加载报表进行编辑 | 用户从报表列表选择报表并点击"编辑"时，报表设计通过 API 从后端获取，画布设计器显示加载的报表，所有单元格、样式和绑定被恢复 |
| 触发自动保存 | 用户进行更改且 30 秒内没有保存时，触发自动保存，报表设计通过 API 发送到后端，状态栏出现"自动保存"指示器 |
| 用户打开带有未保存更改的报表 | 用户尝试打开另一个报表而不保存当前更改时，出现确认对话框（"您有未保存的更改。保存吗？"），用户可选择保存、不保存或取消 |

#### REQ-RDU-005: 性能要求
报表设计器必须在大报表下流畅运行。

| 场景 | 预期行为 |
|------|----------|
| 设计器加载大报表（1000+ 单元格） | 用户打开带有 1000+ 单元格的报表时，画布在 3 秒内加载，所有单元格渲染，用户可立即与单元格交互 |
| 设计器处理大报表滚动 | 用户在带有 10000+ 单元格的报表中滚动时，滚动流畅（60 FPS），仅渲染可见单元格（虚拟滚动），不发生延迟或冻结 |
| 设计器处理大报表单元格选择 | 用户在大报表中选择 100+ 单元格时，选择操作在 100ms 内完成，所有选定单元格高亮，属性面板立即更新 |
| 设计器处理大报表复制粘贴 | 用户在大报表中复制和粘贴 50+ 单元格时，复制粘贴操作在 500ms 内完成，所有单元格正确粘贴，不发生内存泄漏 |

#### REQ-RDU-006: 键盘快捷键
系统必须为常用操作提供键盘快捷键以提高生产力。

| 场景 | 预期行为 |
|------|----------|
| 用户使用 Ctrl+C 复制单元格 | 用户选择单元格并按 Ctrl+C 时，单元格复制到剪贴板，出现"已复制"提示 |
| 用户使用 Ctrl+V 粘贴单元格 | 用户剪贴板中有单元格并按 Ctrl+V 时，单元格粘贴到当前光标位置，所有单元格属性（样式、绑定）被保留 |
| 用户使用 Ctrl+Z 撤销 | 用户按 Ctrl+Z 时，撤销上一个操作，画布恢复到上一个状态，撤销可对多个操作重复 |
| 用户使用 Ctrl+Y 重做 | 用户按 Ctrl+Y 时，重做上一个撤销的操作，画布恢复到重做状态，重做可对多个撤销操作重复 |
| 用户使用 Delete 删除单元格内容 | 用户选择单元格并按 Delete 键时，清除单元格内容，单元格样式被保留，单元格绑定被保留 |
| 用户使用 Ctrl+S 保存报表 | 用户按 Ctrl+S 时，通过 API 保存报表，显示成功消息，操作比点击"保存"按钮更快 |

#### REQ-RDU-007: 右键菜单
系统必须提供右键菜单以便快速访问常用单元格操作。

| 场景 | 预期行为 |
|------|----------|
| 用户右键点击单元格 | 用户右键点击单元格时，右键菜单出现在光标位置，菜单包含：剪切、复制、粘贴、删除、格式单元格、数据绑定、合并单元格、取消合并单元格 |
| 用户右键点击合并单元格 | 用户右键点击合并单元格时，右键菜单包含"取消合并单元格"而不是"合并单元格"，所有其他选项可用 |
| 用户右键点击空白区域 | 用户右键点击空白画布区域时，右键菜单包含：粘贴、插入行、插入列、删除行、删除列 |
| 用户选择右键菜单项 | 用户点击右键菜单中的项目时，执行相应操作，右键菜单关闭，更改保存到报表设计 |

#### REQ-RDU-008: 报表预览页面
系统必须提供报表预览页面，显示带有数据库实际数据的渲染报表。

| 场景 | 预期行为 |
|------|----------|
| 用户查看报表预览 | 用户使用有效报表 ID 打开报表预览页面时，系统从后端加载报表配置，系统调用报表预览 API 渲染报表，系统显示带有实际数据的渲染 HTML，工具栏带有刷新和导出按钮可见 |
| 用户刷新报表预览 | 用户在预览页面上点击刷新按钮时，系统从数据库重新获取数据，系统重新渲染报表，预览显示更新的数据 |
| 用户导出报表 | 用户在预览页面上点击导出按钮时，系统显示导出选项（Excel、PDF 等），用户可以选定格式下载报表 |
| 带参数预览 | 用户使用 URL 参数打开预览页面时，系统将参数传递给渲染引擎，报表以参数化数据渲染 |

#### REQ-RDU-009: 前端报表 API 集成
前端必须提供 API 客户端函数与后端报表 CRUD 和预览端点交互。

| 场景 | 预期行为 |
|------|----------|
| 通过 API 创建报表 | 前端调用报表创建 API 时，请求包含报表名称和配置 JSON，后端创建报表记录并返回报表 ID |
| 通过 API 更新报表 | 前端调用报表更新 API 时，请求包含报表 ID 和更新配置，后端持久化更改并返回更新报表 |
| 通过 API 预览报表 | 前端调用报表预览 API 时，请求包含报表 ID 和可选参数，后端用数据渲染报表并返回 HTML |

#### REQ-RDU-010: 报表设计器路由
前端必须提供访问报表设计器和预览页面的路由，带有适当的认证守卫。

| 场景 | 预期行为 |
|------|----------|
| 用户导航到报表设计器 | 认证用户导航到 `/report/designer` 时，显示报表设计器页面，画布用网格初始化，工具栏和属性面板可见 |
| 用户导航到报表预览 | 认证用户导航到 `/report/preview?id=<report-id>` 时，显示报表预览页面，报表以实际数据渲染，未认证用户重定向到登录 |

#### REQ-RDU-011: 属性面板样式配置
属性面板必须提供用于配置单元格样式（包括字体、对齐、边框和颜色）的 UI。

| 场景 | 预期行为 |
|------|----------|
| 用户配置单元格字体 | 用户在设计器中选择单元格时，属性面板显示字体控件（大小、字体系列、粗细、样式），用户可更改字体属性，更改立即应用于画布 |
| 用户配置单元格对齐 | 用户在设计器中选择单元格时，属性面板显示对齐控件（左、中、右、上、中、下），用户可更改对齐，更改立即应用于画布 |
| 用户配置单元格边框 | 用户在设计器中选择单元格时，属性面板显示边框控件（上、下、左、右、全部），用户可更改边框样式和宽度，更改立即应用于画布 |

---

## 6. 报表渲染与预览

### 6.1 报表渲染后端 (report-rendering)

#### REQ-RR-001: 报表渲染端点
后端必须提供报表视图端点，通过标识符和可选参数渲染报表。

| 场景 | 预期行为 |
|------|----------|
| 通过 ID 渲染报表 | 用户使用有效报表 ID 和参数请求报表时，系统返回渲染的报表视图 |

#### REQ-RR-002: 报表路由兼容性
后端必须保留现有报表路由前缀 `/jmreport/` 用于报表渲染和视图访问。

| 场景 | 预期行为 |
|------|----------|
| 现有 UI 路由访问 | UI 请求 `/jmreport/` 下的视图时，后端提供兼容响应而无需 UI 更改 |

### 6.2 报表渲染器 UI (report-renderer-ui)

#### REQ-RRU-001: 报表预览
系统必须提供报表预览，显示从数据源填充实际数据的报表。

| 场景 | 预期行为 |
|------|----------|
| 用户使用样本数据预览报表 | 用户在设计器中点击"预览"按钮时，使用数据源的样本数据渲染报表，所有单元格显示实际数据值，绑定表达式被计算并显示，报表以只读模式显示，工具栏显示"预览"模式 |
| 用户使用参数预览报表 | 用户输入参数值（例如日期范围、用户 ID）并点击"预览"时，使用参数过滤的数据渲染报表，参数值显示在标题中，表达式使用参数上下文重新计算 |
| 用户刷新预览 | 用户在预览模式中点击"刷新"按钮时，使用数据源的新数据重新渲染报表，刷新期间显示加载指示器，小报表（<1000 行）刷新在 2 秒内完成 |
| 用户退出预览 | 用户点击"返回设计器"按钮时，关闭预览模式，使用原始报表设计重新打开设计器，预览中的未保存更改被丢弃 |

#### REQ-RRU-002: 报表分页
系统必须为具有多行的报表支持报表分页。

| 场景 | 预期行为 |
|------|----------|
| 报表带分页显示 | 报表有超过 50 行时，报表以页面显示（默认每页 50 行），分页控件出现在报表底部，控件显示："第 X 页，共 Y 页"、"上一页"、"下一页"，默认显示第 1 页 |
| 用户导航到下一页 | 用户在分页中点击"下一页"按钮时，显示报表下一页，如果在最后一页则禁用"下一页"按钮，页指示器更新显示当前页面 |
| 用户导航到上一页 | 用户在分页中点击"上一页"按钮时，显示报表上一页，如果在第一页则禁用"上一页"按钮，页指示器更新显示当前页面 |
| 用户跳转到特定页面 | 用户输入页码并按 Enter 时，显示指定页面，如果页码无效则出现错误消息，页面限制在有效范围内 |
| 用户更改页面大小 | 用户选择不同的页面大小（25、50、100、200）时，更新页面大小，使用新页面大小重新渲染报表，分页控件更新（页数更改），用户返回第 1 页 |
| 报表不带分页显示（小报表） | 报表有 50 行或更少时，隐藏分页控件，所有行显示在单页上 |

#### REQ-RRU-003: 打印预览
系统必须提供打印预览，显示报表打印时的外观。

| 场景 | 预期行为 |
|------|----------|
| 用户打开打印预览 | 用户点击"打印预览"按钮时，报表以打印预览模式显示，页面大小匹配配置的纸张大小（默认 A4），应用页面方向（纵向或横向），出现打印预览工具栏（打印、页面设置、关闭） |
| 用户在打印预览中更改纸张大小 | 用户选择不同的纸张大小（A4、A3、Letter）时，报表重新布局以适应新纸张大小，页面宽度和高度相应调整，需要时缩放或换行内容 |
| 用户在打印预览中更改页面方向 | 用户在纵向和横向之间切换时，报表旋转以匹配方向，内容重新流动以适应新方向，页数可能更改 |
| 用户在打印预览中设置边距 | 用户调整边距值（上、下、左、右）时，可打印区域减少边距大小，内容重新布局以适应可打印区域，边距在预览中显示为虚线 |
| 用户从打印预览打印 | 用户点击"打印"按钮时，打开浏览器打印对话框，报表格式化用于打印（隐藏 UI 元素），应用打印设置（纸张大小、方向、边距） |

#### REQ-RRU-004: 导出对话框
系统必须提供导出对话框，用于在生成导出文件之前配置导出选项。

| 场景 | 预期行为 |
|------|----------|
| 用户打开导出对话框 | 用户点击"导出"按钮时，显示导出对话框，用户可选择导出格式（Excel、PDF、Word、Image），用户可为选定格式配置导出选项 |
| 用户配置 Excel 导出 | 用户选择"Excel"格式时，显示 Excel 特定选项：包含标题（是/否）、包含样式（是/否）、工作表名称、编码，预选默认值 |
| 用户配置 PDF 导出 | 用户选择"PDF"格式时，显示 PDF 特定选项：纸张大小（A4、A3、Letter）、方向（纵向、横向）、边距、包含页码（是/否）、质量（高、中、低），预选默认值 |
| 用户配置 Word 导出 | 用户选择"Word"格式时，显示 Word 特定选项：包含标题（是/否）、包含样式（是/否）、文档模板，预选默认值 |
| 用户配置 Image 导出 | 用户选择"Image"格式时，显示 Image 特定选项：图像格式（PNG、JPG、SVG）、分辨率（DPI）、质量（1-100）、背景颜色（透明、白色），预选默认值 |
| 用户开始导出 | 用户配置选项并点击"导出"时，通过后端 API 创建导出作业，显示进度指示器，导出在后台运行时用户可继续工作，导出完成时通知用户 |

#### REQ-RRU-005: 导出进度
系统必须显示导出进度并允许用户下载已完成的导出。

| 场景 | 预期行为 |
|------|----------|
| 导出进行中 | 导出作业运行时，进度指示器显示完成百分比，进度指示器显示估计剩余时间，用户可通过点击"取消"取消导出 |
| 导出成功完成 | 导出作业成功完成时，显示成功消息，出现"下载"按钮，存储导出作业 ID 供将来参考 |
| 用户下载已完成的导出 | 用户点击"下载"按钮时，浏览器下载导出文件，文件名包含报表名称和时间戳，文件格式匹配选定格式 |
| 导出失败带错误 | 导出作业失败时，显示带有错误详情的错误消息，如果可用则显示错误日志，用户可重试导出，记录错误以供故障排除 |

#### REQ-RRU-006: 渲染器性能要求
报表渲染器必须高效处理大型数据集。

| 场景 | 预期行为 |
|------|----------|
| 渲染带有 10,000 行的报表 | 用户预览带有 10,000 行的报表时，报表在 3 秒内加载，应用分页（每页 50 行），用户可平滑浏览页面 |
| 渲染带有复杂表达式的报表 | 用户预览带有 500 个包含表达式的单元格的报表时，所有表达式在 2 秒内计算，正确显示计算值，不发生延迟或冻结 |
| 渲染带有图表的报表 | 用户预览带有 10 个图表组件的报表时，所有图表在 3 秒内渲染，图表以正确数据显示，图表可交互（悬停、提示） |
| 在预览和设计器之间切换 | 用户从预览切换到设计器并返回时，切换在 500ms 内完成，保留报表状态，不发生数据丢失 |

#### REQ-RRU-007: 响应式设计
报表渲染器必须适应不同的屏幕尺寸和设备。

| 场景 | 预期行为 |
|------|----------|
| 在大屏幕上查看报表 | 用户在屏幕宽度 > 1920px 查看报表时，报表以全宽显示，内容最佳间距，不出现水平滚动条 |
| 在中等屏幕上查看报表 | 用户在屏幕宽度 1024-1920px 查看报表时，报表适合屏幕宽度，需要时缩放内容，仅在内容太宽时出现水平滚动条 |
| 在小屏幕上查看报表 | 用户在屏幕宽度 < 1024px 查看报表时，报表针对小屏幕优化，启用水平滚动，应用响应式布局 |
| 在移动设备上查看报表 | 用户在移动设备（宽度 < 768px）查看报表时，报表以移动友好的布局显示，表格可水平滚动，分页控件针对触摸优化，导出选项在可折叠菜单中可用 |

---

## 7. 报表导出

### 7.1 报表导出 (report-export)

#### REQ-RE-001: 导出格式
后端必须支持将报表导出为 PDF、Excel、Word 和 Image 格式。

| 场景 | 预期行为 |
|------|----------|
| 导出为 PDF | 用户请求 PDF 格式的报表导出时，系统返回可下载的 PDF |

#### REQ-RE-002: 打印参数
后端必须在导出和打印期间应用报表参数。

| 场景 | 预期行为 |
|------|----------|
| 参数化导出 | 用户使用过滤参数导出报表时，导出文件反映过滤数据 |

---

## 8. BI 仪表盘

### 8.1 仪表盘后端 (bi-dashboard)

#### REQ-BD-001: 仪表盘设计器访问
后端必须为授权用户提供仪表盘设计器入口路由 `/drag/list`。

| 场景 | 预期行为 |
|------|----------|
| 访问仪表盘设计器 | 认证用户访问 `/drag/list` 时，仪表盘设计器 UI 可用 |

#### REQ-BD-002: 仪表盘 CRUD
后端必须提供用于创建、更新、列出和删除仪表盘定义的 API。

| 场景 | 预期行为 |
|------|----------|
| 更新仪表盘 | 用户更新现有仪表盘时，更新后的仪表盘被持久化并可用于预览 |

#### REQ-BD-003: 仪表盘数据集绑定
仪表盘设计器必须支持将仪表盘小部件绑定到数据集维度和度量。

| 场景 | 预期行为 |
|------|----------|
| 将小部件绑定到数据集 | 用户在仪表盘设计器中添加或编辑小部件时，可选择数据集作为数据源，数据集下拉菜单显示所有可用数据集，选择数据集加载维度和度量 |
| 使用数据集维度配置小部件 | 用户配置小部件维度轴（X 轴、类别）时，可从数据集维度列表选择维度，显示维度显示名称，可启用分组，小部件配置引用数据集 ID 和维度名 |
| 使用数据集度量配置小部件 | 用户配置小部件度量轴（Y 轴、值）时，可从数据集度量列表选择度量，可选择聚合函数，可为多系列小部件选择多个度量，小部件配置引用数据集 ID 和度量名 |
| 保存带有数据集绑定的仪表盘 | 用户保存带有数据集绑定小部件的仪表盘时，存储带有数据集 ID 的小部件配置，存储维度和度量引用，存储聚合和分组设置 |
| 使用数据集数据渲染仪表盘 | 加载或预览仪表盘时，后端为所有小部件加载数据集配置，后端为每个小部件查询数据集数据，后端应用计算字段、分组、聚合，后端返回小部件特定数据，小部件以实际数据渲染 |

#### REQ-BD-004: 仪表盘持久化契约兼容性
系统必须使用确定性载荷模式持久化和检索仪表盘定义，包括仪表盘配置和组件定义。

| 场景 | 预期行为 |
|------|----------|
| 确定性地保存和加载仪表盘定义 | 用户从设计器保存仪表盘时，后端使用规范模式持久化仪表盘配置和组件载荷；用户重新加载仪表盘时，后端返回重现原始布局和组件设置的等效结构 |
| 历史记录的向后兼容性 | 存储的仪表盘记录具有部分或遗留配置字段时，后端应用兼容性默认值并返回有效响应信封，前端可渲染和编辑而无需运行时崩溃 |

### 8.2 仪表盘 UI (bi-dashboard-ui)

#### REQ-BDU-001: 仪表盘画布设计器
系统必须提供基于画布的仪表盘设计器，允许用户通过拖放组件创建交互式仪表盘。

| 场景 | 预期行为 |
|------|----------|
| 用户创建新仪表盘 | 用户点击"创建仪表盘"按钮时，显示空白画布设计器，画布大小可配置（默认 1920x1080），网格可见用于对齐，左侧可见组件面板，右侧可见属性面板 |
| 用户更改画布大小 | 用户在画布设置中输入新的宽度和高度时，立即更新画布大小，如果需要则按比例重新定位所有组件，保持画布中心 |
| 用户缩放画布 | 用户使用鼠标滚轮或缩放控件缩放时，画布放大或缩小（10% 增量，50%-200% 范围），组件按比例缩放，状态栏显示缩放百分比 |
| 用户平移画布 | 用户按住空格键并拖动鼠标时，画布向拖动方向平移，应用平滑滚动，尊重画布边界 |
| 用户保存仪表盘 | 用户点击"保存"按钮时，仪表盘设计通过 API 发送到后端，显示成功消息，状态栏出现"已保存"指示器，重置自动保存计时器 |

#### REQ-BDU-002: 组件拖放
系统必须允许用户从组件面板拖动组件并放置到画布上。

| 场景 | 预期行为 |
|------|----------|
| 用户从面板拖动组件到画布 | 用户开始拖动组件（例如"文本卡片"）时，组件跟随鼠标光标带有阴影，画布上出现放置目标指示器，网格吸附点可见 |
| 用户在画布上放置组件 | 用户在画布上释放鼠标时，组件放置在放置位置，组件吸附到最近的网格点，组件被选中且属性面板显示其属性，放置记录在撤销历史中 |
| 用户在画布上拖动组件以移动 | 用户拖动现有组件时，组件跟随鼠标光标，保持原始位置（幽灵图像），出现放置目标指示器，网格吸附点可见 |
| 用户放置移动的组件 | 用户释放鼠标完成移动时，组件移动到新位置，组件吸附到网格，移动记录在撤销历史中，保持图层顺序 |
| 用户在画布外拖动组件 | 用户将组件拖动超出画布边界时，放置目标指示器显示"无效"（红色），组件以红色高亮，阻止放置（组件返回原始位置） |

#### REQ-BDU-003: 组件属性配置
系统必须提供用于配置组件属性的属性面板。

| 场景 | 预期行为 |
|------|----------|
| 用户选择组件 | 用户点击画布上的组件时，组件以选择边框高亮，属性面板显示组件属性，属性分组（通用、样式、数据、交互），图层面板高亮组件的图层 |
| 用户更改组件通用属性 | 用户编辑通用属性（例如标题、ID）时，属性更改立即在画布上反映，更改记录在撤销历史中，属性值被验证（如需要） |
| 用户更改组件样式属性 | 用户编辑样式属性（例如字体大小、颜色）时，样式更改立即在画布上反映，更改记录在撤销历史中，复杂属性使用颜色选择器或字体选择器 |
| 用户更改组件数据属性 | 用户配置数据属性（例如数据源、字段）时，从后端加载数据属性选项，用户可测试数据连接，数据预览可用，更改记录在撤销历史中 |
| 用户更改组件交互属性 | 用户配置交互（例如链接、下钻）时，保存交互配置，在预览模式中测试交互，更改记录在撤销历史中 |

#### REQ-BDU-004: 图层管理
系统必须提供用于管理组件图层（顺序、可见性、锁定）的图层面板。

| 场景 | 预期行为 |
|------|----------|
| 用户查看图层面板 | 仪表盘设计器打开时，右侧可见图层面板，画布上的所有组件列在图层面板中，图层从上到下排序，每个图层显示可见性切换 |
| 用户通过拖动重新排序图层 | 用户在图层面板中拖动图层时，图层跟随鼠标光标，图层之间出现放置目标指示器，放置时画布上的图层顺序立即更改 |
| 用户通过按钮重新排序图层 | 用户为图层点击"上移"或"下移"按钮时，图层向上或向下移动一个位置，画布上的图层顺序立即更改，顶部和底部图层禁用按钮 |
| 用户切换图层可见性 | 用户为图层点击可见性切换（眼睛图标）时，组件在画布上隐藏，切换更改为"隐藏"状态，组件保留在图层面板中，隐藏组件不被导出或预览 |
| 用户锁定图层 | 用户为图层点击锁定切换（锁图标）时，组件无法在画布上选择或移动，锁图标更改为"锁定"状态，锁定图层无法重新排序，锁定图层属性无法编辑 |
| 用户删除图层 | 用户为图层点击删除按钮时，出现确认对话框，如果确认，从画布移除组件，从图层面板移除图层，删除记录在撤销历史中 |

#### REQ-BDU-005: 数据绑定
系统必须允许用户将组件绑定到数据源以进行动态数据显示。

| 场景 | 预期行为 |
|------|----------|
| 用户将组件绑定到数据库字段 | 用户选择组件并打开数据绑定对话框时，可从下拉菜单选择数据源，可从数据源选择表，可从表选择字段，绑定预览中显示选定字段，绑定保存到组件属性 |
| 用户为组件配置 SQL 查询 | 用户选择"自定义 SQL"数据源选项时，显示 SQL 编辑器，可编写或编辑 SQL 查询，应用语法高亮，保存前可测试 SQL |
| 用户测试数据绑定 | 用户在数据绑定对话框中点击"测试"按钮时，系统执行 SQL 查询或获取数据，预览表中显示样本数据，显示数据行数，显示查询执行时间 |
| 用户配置数据刷新间隔 | 用户设置刷新间隔（例如 60 秒）时，组件数据以指定间隔刷新，组件上显示刷新指示器，设置间隔为 0 可禁用刷新 |
| 用户配置数据过滤 | 用户向数据绑定添加过滤条件时，过滤条件应用于数据查询，可组合多个过滤器（AND/OR 逻辑），支持过滤运算符（=、>、<、LIKE、IN 等），保存前可测试过滤器 |

#### REQ-BDU-006: 仪表盘预览
系统必须提供预览模式，以查看仪表盘在最终用户眼中的外观。

| 场景 | 预期行为 |
|------|----------|
| 用户打开预览模式 | 用户点击"预览"按钮时，仪表盘以预览模式显示，设计器元素（网格、选择边框、调整大小手柄）隐藏，属性面板和图层面板隐藏，工具栏更改为预览工具栏（刷新、全屏、关闭） |
| 用户使用真实数据预览仪表盘 | 仪表盘处于预览模式时，所有组件显示数据源的真实数据，以配置的间隔刷新数据，启用交互功能（下钻、悬停），不允许编辑 |
| 用户在预览中刷新仪表盘 | 用户在预览中点击"刷新"按钮时，刷新所有组件数据，刷新期间显示刷新指示器，更新最后刷新时间戳，如果任何组件刷新失败则显示错误 |
| 用户查看全屏预览 | 用户在预览中点击"全屏"按钮时，仪表盘扩展到全屏，使用浏览器全屏 API，角落显示"退出全屏"按钮，仪表盘居中并缩放以适应屏幕 |
| 用户退出预览模式 | 用户在预览中点击"关闭"按钮时，关闭预览模式，重新打开设计器模式，恢复所有设计器元素，丢弃预览中的未保存更改 |

#### REQ-BDU-007: 常用仪表盘组件
系统必须提供用于构建仪表盘的常用仪表盘组件。

| 场景 | 预期行为 |
|------|----------|
| 用户添加文本卡片组件 | 用户将"文本卡片"拖到画布时，创建带有默认内容的文本卡片，属性面板显示文本卡片属性：标题、内容（富文本）、背景颜色、边框样式、内边距 |
| 用户添加图像组件 | 用户将"图像"拖到画布时，创建图像组件，属性面板显示图像属性：图像源（上传或 URL）、宽度和高度、边框半径、适应模式（覆盖、包含、拉伸） |
| 用户添加数字卡片组件 | 用户将"数字卡片"拖到画布时，创建数字卡片，属性面板显示数字卡片属性：标题、数据绑定、数字格式、趋势指示器（箭头、颜色）、单位 |
| 用户添加表格组件 | 用户将"表格"拖到画布时，创建带有样本数据的表格组件，属性面板显示表格属性：数据源绑定、列配置（宽度、对齐、格式）、行高、标题样式、分页（是/否） |
| 用户添加边框框架组件 | 用户将"边框框架"拖到画布时，创建边框框架，属性面板显示边框属性：边框样式（实线、虚线、双线）、边框颜色、边框宽度、角半径、背景颜色、标题文本和样式 |
| 用户添加图表组件 | 用户将"图表"拖到画布时，创建带有样本图表的图表组件，属性面板显示图表属性：图表类型（柱状、折线、饼图等）、数据源绑定、标题和副标题、图例设置、轴设置、配色方案、动画 |

#### REQ-BDU-008: 仪表盘设计器性能要求
仪表盘设计器必须在许多组件和大型数据集下流畅运行。

| 场景 | 预期行为 |
|------|----------|
| 设计器加载带有 50 个组件的仪表盘 | 用户打开带有 50 个组件的仪表盘时，画布在 2 秒内加载，所有组件渲染，图层面板列出所有组件，用户可立即与组件交互 |
| 设计器处理带有许多组件的拖放 | 用户在带有 50+ 组件的画布上拖动组件时，拖放流畅（60 FPS），放置指示器实时更新，不发生延迟或冻结 |
| 预览加载带有真实数据的仪表盘 | 用户预览带有 50 个组件和 10 个数据源的仪表盘时，预览在 3 秒内加载，所有组件显示数据，数据刷新在 2 秒内完成 |
| 仪表盘处理实时数据刷新 | 仪表盘处于预览模式且有 20+ 组件配置为每 60 秒刷新时，所有组件按计划刷新，每个组件刷新在 1 秒内完成，不发生 UI 延迟或冻结，如果任何组件失败则显示刷新错误 |

#### REQ-BDU-009: 设计器保存-加载运行时一致性
仪表盘设计器必须在保存和重新加载后一致地恢复持久化的组件状态。

| 场景 | 预期行为 |
|------|----------|
| 用户在设计器中重新加载保存的仪表盘 | 用户保存仪表盘并稍后加载到设计器时，从持久化载荷恢复组件列表、图层顺序、样式设置和数据绑定，设计器不依赖硬编码模拟组件默认值进行恢复 |

#### REQ-BDU-010: 预览基线渲染持久化组件
仪表盘预览必须基于持久化组件载荷渲染最小运行时基线，而不是仅占位符视图。

| 场景 | 预期行为 |
|------|----------|
| 预览渲染基线组件输出 | 用户在加载保存的仪表盘后进入预览模式时，预览使用持久化数据为支持的组件类型渲染基线输出，预览刷新操作更新渲染状态而不切换到仅占位符内容 |

---

## 9. 图表编辑器

### 9.1 图表编辑器 UI (chart-editor-ui)

#### REQ-CEU-001: 图表类型选择
系统必须提供图表类型选择器，允许用户从 28+ 种图表类型中选择。

| 场景 | 预期行为 |
|------|----------|
| 用户打开图表类型选择器 | 用户打开图表编辑器或点击图表类型下拉菜单时，显示图表类型选择器，图表类型按类别分组（基础、高级、地图等），每种图表类型有图标和名称，选定的图表类型高亮 |
| 用户选择基础图表类型 | 用户选择基础图表（柱状、折线、饼图、散点）时，图表类型应用于图表，预览区域显示选定的图表类型，属性面板显示相关属性，更改保存到图表配置 |
| 用户选择高级图表类型 | 用户选择高级图表（漏斗、雷达、仪表等）时，图表类型应用于图表，预览区域显示选定的图表类型，属性面板显示高级特定属性，显示图表类型描述 |
| 用户选择地图图表类型 | 用户选择地图图表（中国地图、世界地图、热力图）时，加载地图数据（地图 JSON 或 GeoJSON），预览区域显示地图，显示地图特定属性（区域、缩放等），地图可平移和缩放 |
| 用户搜索图表类型 | 用户在图表类型搜索框中输入时，图表类型按搜索词过滤，匹配的图表类型高亮，不匹配的图表类型灰显或隐藏 |

#### REQ-CEU-002: ECharts 集成
系统必须集成 ECharts 库以渲染具有完整功能支持的图表。

| 场景 | 预期行为 |
|------|----------|
| 图表使用 ECharts 渲染 | 图表显示时（在编辑器或预览中），创建并挂载 ECharts 实例，图表以指定配置渲染，图表响应容器大小更改，组件销毁时清理图表实例 |
| 图表支持 ECharts 功能 | 用户与图表交互（悬停、点击、缩放）时，捕获并处理 ECharts 事件，悬停时显示提示，如果配置则启用数据缩放，点击时图例切换有效，如果配置则触发下钻 |
| 图表使用新数据更新 | 图表数据更改时（通过数据绑定或手动输入），使用 ECharts setOption API 更新图表，图表平滑过渡到新数据，如果配置则应用动画，不发生闪烁或闪动 |
| 图表随容器调整大小 | 图表容器大小更改时（窗口调整大小、父级调整大小），图表自动调整大小，如果配置则图表保持纵横比，图表标签为新大小调整，不发生失真或裁剪 |

#### REQ-CEU-003: 数据源配置
系统必须允许用户为图表配置数据源，支持 SQL 查询、API 调用和静态数据。

| 场景 | 预期行为 |
|------|----------|
| 用户将图表绑定到 SQL 数据源 | 用户选择"SQL"数据源类型时，显示 SQL 编辑器，可从下拉菜单选择数据库连接，可编写或编辑 SQL 查询，应用 SQL 语法高亮，保存前可验证 SQL |
| 用户测试 SQL 数据源 | 用户在 SQL 数据源配置中点击"测试"按钮时，针对数据库执行 SQL 查询，预览表中显示样本数据（前 50 行），显示查询执行时间，如果查询失败则显示错误消息，检测列名和数据类型 |
| 用户将图表绑定到 API 数据源 | 用户选择"API"数据源类型时，显示 API 配置表单，可输入 API 端点 URL，可配置 HTTP 方法（GET、POST），可添加请求标头（例如 Authorization），可添加请求体（用于 POST），保存前可测试 API |
| 用户为图表配置静态数据 | 用户选择"静态"数据源类型时，显示 JSON 编辑器，可输入或粘贴 JSON 数据，应用 JSON 语法高亮，可验证 JSON，检查 JSON 格式（对象数组） |
| 用户将图表字段映射到数据字段 | 用户配置图表数据源时，显示字段映射界面，可将图表维度（X 轴、类别）映射到数据字段，可将图表度量（Y 轴、值）映射到数据字段，可配置分组或聚合，验证字段映射（必需字段必须映射） |

#### REQ-CEU-004: 图表属性配置
系统必须提供用于配置图表属性（标题、图例、轴、系列、样式等）的属性面板。

| 场景 | 预期行为 |
|------|----------|
| 用户配置图表标题 | 用户编辑图表标题属性时，图表预览上更新标题文本，标题可定位（上、下、左、右），可配置标题字体（大小、颜色、粗细），清除文本可隐藏标题 |
| 用户配置图表图例 | 用户编辑图表图例属性时，图表预览上更新图例，图例可定位（上、下、左、右），可隐藏图例，可配置图例项目字体，如果项目多则图例可滚动 |
| 用户配置图表 X 轴 | 用户编辑 X 轴属性时，图表预览上更新 X 轴，可配置轴标题，可配置轴标签旋转，可配置轴线和刻度线，可配置轴刻度（线性、对数、时间） |
| 用户配置图表 Y 轴 | 用户编辑 Y 轴属性时，图表预览上更新 Y 轴，可配置轴标题，可配置轴最小值和最大值，可隐藏轴，可为多系列图表添加多个 Y 轴 |
| 用户配置图表系列 | 用户编辑系列属性时，图表预览上更新系列，可配置系列名称，可配置系列类型（柱状、折线、散点等），可配置系列颜色（纯色或渐变），可添加和重新排序多个系列 |
| 用户配置图表提示 | 用户编辑提示属性时，更新提示行为，可配置提示在悬停或点击时显示，可自定义提示内容（模板变量），可配置提示触发器（轴、项目、无），可配置提示样式（背景、边框、字体） |
| 用户配置图表动画 | 用户编辑动画属性时，更新动画行为，可配置动画持续时间，可配置动画缓动，可禁用动画，数据更改时预览动画 |

#### REQ-CEU-005: 实时预览
系统必须提供实时预览，随属性和数据更改更新图表。

| 场景 | 预期行为 |
|------|----------|
| 属性更改时预览更新 | 用户更改任何图表属性（标题、颜色等）时，图表预览立即更新（防抖 300ms），平滑应用更改并过渡，必要时重新渲染图表，不发生闪烁或闪动 |
| 数据更改时预览更新 | 用户更改图表数据或数据绑定时，图表预览以新数据更新，如果数据显著更改则应用动画，更新数据点而不完全重新渲染，必要时调整轴范围 |
| 用户刷新预览数据 | 用户点击"刷新数据"按钮时，再次从数据源获取数据，图表预览以新数据更新，更新刷新时间戳，刷新期间显示加载指示器 |
| 预览显示加载状态 | 图表加载数据或渲染时，显示加载旋转器或骨架，先前图表变暗或隐藏，加载指示器位于图表中心，图表就绪时清除加载状态 |

#### REQ-CEU-006: 常用图表类型
系统必须支持业务报告中使用的常用图表类型。

| 场景 | 预期行为 |
|------|----------|
| 用户创建柱状图 | 用户选择"柱状图"类型时，使用样本数据创建柱状图，柱子可配置为垂直或水平，柱子可堆叠或分组，可配置柱子宽度和间隙，柱子颜色可为单色或多色 |
| 用户创建折线图 | 用户选择"折线图"类型时，使用样本数据创建折线图，折线可配置为平滑（曲线）或直线，折线可有标记（点）或没有，折线下可填充区域，可显示多条折线用于比较 |
| 用户创建饼图 | 用户选择"饼图"类型时，使用样本数据创建饼图，饼图可配置为标准或环形（甜甜圈），饼图可有内半径（甜甜圈孔大小），饼图切片可有标签或没有，饼图可配置为显示百分比或值 |
| 用户创建散点图 | 用户选择"散点图"类型时，使用样本数据创建散点图，散点大小可根据第三维度变化，散点可有颜色维度（气泡图），散点可有回归线（趋势线），散点可有误差条 |
| 用户创建漏斗图 | 用户选择"漏斗图"类型时，使用样本数据创建漏斗图，漏斗可配置为标准或倒置，漏斗标签可在内部或外部，漏斗宽度可从值计算或相等，漏斗可有不同排序（升序、降序） |
| 用户创建雷达图 | 用户选择"雷达图"类型时，使用样本数据创建雷达图，雷达可有多系列用于比较，雷达轴可为圆形或多边形，可配置雷达轴标签，可配置雷达填充区域 |
| 用户创建仪表图 | 用户选择"仪表图"类型时，使用样本数据创建仪表图，仪表可有单个或多个指针，可配置仪表范围（最小、最大），仪表可有颜色区域（绿色、黄色、红色），仪表可有表盘和详细文本 |
| 用户创建地图 | 用户选择"地图"类型时，加载地图（中国、世界或自定义），地图数据显示为区域或点，地图可缩放和平移，地图可有数据层（热力、等值线），地图可有交互（点击区域下钻） |

#### REQ-CEU-007: 图表交互
系统必须支持图表交互（悬停、点击、缩放、图例切换）以增强用户体验。

| 场景 | 预期行为 |
|------|----------|
| 用户悬停在图表元素上 | 用户将鼠标移动到图表元素（柱子、点、切片）上时，显示带有元素数据的提示，元素高亮（颜色更改或边框），提示跟随鼠标光标，提示显示相关字段（名称、值、百分比等） |
| 用户点击图表元素 | 用户点击图表元素（柱子、点、切片）时，捕获点击事件，如果配置则触发下钻，如果配置则打开链接，点击后元素高亮，可自定义点击操作 |
| 用户缩放图表 | 用户使用鼠标滚轮或缩放控件缩放时，图表放大或缩小，缩放限制在轴范围内，缩放可重置为默认，可见缩放控件（放大、缩小、重置） |
| 用户切换图例项目 | 用户点击图例项目时，隐藏或显示相应系列，系列隐藏时图例项目变暗，系列显示时图例项目变亮，图表自动缩放到可见系列，可切换多个系列 |
| 用户选择图表区域 | 用户拖动鼠标选择图表区域时，高亮选定区域，图表缩放到选定区域，可重置区域选择，启用缩放时区域选择有效 |

#### REQ-CEU-008: 图表编辑器性能要求
图表编辑器必须高效处理大型数据集和许多图表元素。

| 场景 | 预期行为 |
|------|----------|
| 编辑器加载带有 10,000 数据点的图表 | 用户打开带有 10,000 数据点的图表时，图表在 2 秒内加载，所有数据点渲染，图表响应（悬停、点击、缩放），不发生内存泄漏 |
| 编辑器处理实时数据更新 | 图表配置为每 5 秒刷新且有 1,000 数据点时，图表平滑更新无延迟，更新在 500ms 内完成，如果数据显著更改则应用动画，不发生冻结或卡顿 |
| 编辑器处理仪表盘上的 50+ 图表 | 仪表盘有 50+ 图表组件时，所有图表在 5 秒内加载，所有图表响应，总内存使用 < 500MB，用户可平滑与所有图表交互 |
| 属性更改时预览更新 | 用户快速更改图表属性（多个滑块）时，预览平滑更新（60 FPS），防抖更改以避免过度重新渲染，不发生闪烁或延迟，快速达到最终状态 |

#### REQ-CEU-009: 图表数据集数据源
图表编辑器必须支持使用数据集作为图表数据源。

| 场景 | 预期行为 |
|------|----------|
| 选择数据集作为图表数据源 | 用户打开图表编辑器数据源配置时，可选择"数据集"作为数据源类型，可从下拉菜单选择特定数据集，数据集选择显示可用维度和度量，维度和度量分开组织 |
| 将图表维度映射到数据集维度 | 用户配置图表维度（X 轴、类别、系列）时，从数据集维度列表选择维度，UI 中显示维度显示名称，显示维度数据类型，如果维度可分组则可启用分组，图表配置引用数据集 ID 和维度字段名 |
| 将图表度量映射到数据集度量 | 用户配置图表度量（Y 轴、值、大小、角度）时，从数据集度量列表选择度量，UI 中显示度量显示名称，可选择聚合函数，可为多系列图表选择多个度量，图表配置引用数据集 ID 和度量字段名 |
| 使用数据集数据预览图表 | 用户预览图表或修改配置时，后端查询数据集数据，后端应用计算字段表达式，后端应用分组和聚合，后端以图表预期格式返回数据，图表以实际数据渲染，预览实时更新 |
| 保存带有数据集的图表配置 | 用户保存图表配置时，在图表配置中存储数据集 ID，存储维度和度量字段引用，存储聚合和分组设置，图表可用更新的数据集数据重用 |
| 在图表中使用计算字段 | 数据集包含计算字段时，计算字段出现在维度或度量列表中，显示计算字段显示名称，可为图表轴选择计算字段，查询图表数据时评估计算字段表达式，图表显示计算字段值 |
| 验证图表-数据集兼容性 | 用户为图表类型选择数据集时，验证数据集具有图表类型所需的字段，如果数据集缺少维度或度量则警告，根据可用字段建议兼容的图表类型 |
| 处理数据集模式更改 | 数据集模式更新（字段添加/删除/重命名）时，验证使用数据集的图表，使用删除字段的图表在编辑器中显示错误，使用重命名字段的图表更新为新字段名，系统记录图表所有者的模式更改通知 |

---

## 10. 查询缓存

### 10.1 查询缓存 (query-cache)

#### REQ-QC-001: 可降级缓存后端
系统必须提供统一缓存接口，支持 Redis 与 Noop 两种后端实现；当 Redis 未启用或不可用时，系统必须自动降级为 Noop 并保持业务可用。

| 场景 | 预期行为 |
|------|----------|
| Redis 未启用 | `cache.enabled=false` 时，系统使用 Noop 缓存后端启动，请求链路不因缓存不可用而失败 |
| Redis 运行时不可用 | Redis 在运行时连接失败或超时时，缓存调用返回降级结果而非中断业务，记录告警日志用于排查 |

#### REQ-QC-002: 缓存键隔离与稳定命中
系统必须使用包含租户、业务域、资源标识和参数哈希的缓存键格式，以保证租户隔离和重复请求稳定命中。

| 场景 | 预期行为 |
|------|----------|
| 同租户重复查询命中缓存 | 同一租户对同一数据源与同一查询参数重复请求时，第二次及后续请求命中缓存 |
| 跨租户查询隔离 | 不同租户请求相同业务对象时，系统使用不同缓存键空间，不发生跨租户数据泄露 |

#### REQ-QC-003: TTL 与显式失效
系统必须为缓存数据设置 TTL，并在数据源更新/删除或报表保存等事件后执行显式失效，避免长期脏读。

| 场景 | 预期行为 |
|------|----------|
| TTL 到期后回源 | 缓存条目 TTL 到期时，系统回源数据库并回填新缓存 |
| 资源更新触发失效 | 数据源配置被更新或删除，或报表配置被保存时，相关键空间缓存被清理，后续读取返回更新后的数据 |

#### REQ-QC-004: 可观测性
系统必须记录缓存命中、未命中、失败与降级事件，便于评估性能收益与稳定性。

| 场景 | 预期行为 |
|------|----------|
| 缓存指标可追踪 | 服务处理缓存相关请求时，产生命中率与失败计数指标，日志中包含 tenant/domain 维度信息（不含敏感数据） |

---

## 11. 前端功能可用性

### 11.1 前端功能可用性 (frontend-feature-availability)

#### REQ-FFA-001: 核心功能入口可见性
前端必须为核心模块暴露可见的导航条目和可路由页面：报表设计器、报表预览、仪表盘设计器和图表编辑器。

| 场景 | 预期行为 |
|------|----------|
| 认证用户登录后看到核心条目 | 认证用户进入应用程序时，主导航显示报表设计器、报表预览、仪表盘设计器和图表编辑器的条目，点击每个条目导航到有效路由而无空白屏幕 |
| 用户直接打开核心路由 | 认证用户通过 URL 直接打开核心模块路由时，渲染相应页面，未授权用户重定向到登录或无权限页面 |

#### REQ-FFA-002: 非空白功能回退
对于任何未完全实现的核心页面，前端必须渲染带有清晰状态和下一步指导的非空白回退状态。

| 场景 | 预期行为 |
|------|----------|
| 用户打开部分实现的模块 | 用户打开具有不完整后端或组件接线的模块时，页面渲染可见的回退状态而不是空内容，回退状态显示模块名称、当前可用性状态和重试操作 |
| 页面初始化期间核心 API 请求失败 | 核心页面在初始化期间无法加载所需数据时，页面渲染带有可操作消息的错误状态，用户可触发重试而无需完全刷新页面 |

#### REQ-FFA-003: UI 模块的最小可用基线
前端必须为仪表盘和图表工作流提供最小可用基线，以便用户可以完成可见的端到端试用路径。

| 场景 | 预期行为 |
|------|----------|
| 用户完成仪表盘基线路径 | 用户创建新仪表盘时，可添加至少一个组件、配置基本属性并打开预览，仪表盘可保存和重新加载 |
| 用户完成图表基线路径 | 用户打开图表编辑器时，可选择图表类型、绑定样本数据、编辑基本属性并查看实时预览，图表配置可持久化和恢复 |

#### REQ-FFA-004: 生产占位符替代 UX
系统必须避免仅返回占位符消息的活动面向用户操作；而是提供带有指导或最小可行工作流的禁用状态。

| 场景 | 预期行为 |
|------|----------|
| 占位符按钮被禁用状态替换 | 用户遇到生产中尚未实现的功能时，UI 元素被禁用，带有工具提示或帮助文本解释可用性时间线，没有活动按钮仅返回"开发中"警报而无额外工作流 |
| 关键占位符的最小可行工作流 | 占位符覆盖关键 MVP 功能时，系统提供最小可用工作流而不是纯占位符，用户可完成主要任务并有记录的限制 |

#### REQ-FFA-005: API 响应中的可操作错误诊断
后端处理程序必须返回显式验证/契约错误诊断，而不是通用的"无效请求"。

| 场景 | 预期行为 |
|------|----------|
| 请求绑定失败包含字段上下文 | 请求验证或绑定失败时，响应包含字段路径和可操作消息，状态码为 4xx 且具有确定性错误结构 |
| 权限和下游错误可区分 | 操作由于权限与下游与验证失败时，错误响应形状允许客户端区分类别，消息文本指导用户解决 |

#### REQ-FFA-006: 前端错误表面优先考虑后端消息
前端错误呈现必须优先考虑后端诊断消息，而不是通用传输错误。

| 场景 | 预期行为 |
|------|----------|
| API 错误显示后端消息 | API 调用返回带有后端消息字段的错误响应时，UI 显示该消息作为主要错误文本，仅在后端消息缺失时回退到通用文本 |
| 网络/传输错误具有优雅回退 | 请求在传输层失败（网络、超时）时，UI 显示带有重试指导的可操作回退，技术详情在控制台可用但不是面向用户的警报 |

---

## 12. 系统集成与兼容性

### 12.1 迁移兼容性 (migration-compatibility)

#### REQ-MC-001: MySQL 模式兼容性
Go 后端必须重用现有 goReport MySQL 模式，无需破坏性迁移。

| 场景 | 预期行为 |
|------|----------|
| 现有数据库重用 | Go 服务针对现有 goReport 数据库启动时，现有报表和仪表盘保持可用 |

#### REQ-MC-002: 路由兼容性
后端必须为 UI 访问保留现有路由前缀（`/jmreport/*` 和 `/drag/*`）。

| 场景 | 预期行为 |
|------|----------|
| 遗留链接访问 | 用户访问 `/jmreport/` 或 `/drag/` 下的遗留链接时，请求成功解决而无需 UI 更改 |

### 12.2 嵌入式集成 (embedding-integration)

#### REQ-EI-001: Token 输入通道
后端必须从标准请求头和可选查询参数接受 JWT 令牌用于嵌入式场景。

| 场景 | 预期行为 |
|------|----------|
| 通过查询参数传递 Token | 请求在查询参数中包含 JWT 时，验证并使用令牌进行授权 |

#### REQ-EI-002: 可配置 CORS
后端必须允许为嵌入式访问配置 CORS 策略。

| 场景 | 预期行为 |
|------|----------|
| 允许特定来源 | 系统配置有允许的来源时，来自该来源的请求包含适当的 CORS 标头 |

### 12.3 数据库配置 (database-config)

#### REQ-DBC-001: 数据库配置
系统必须支持通过环境变量配置数据库，具有合理的默认值。

| 场景 | 预期行为 |
|------|----------|
| 加载数据库配置 | 应用程序启动时，加载 DB_DSN 环境变量，如果未提供则使用默认连接字符串，记录成功数据库连接 |
| 数据库连接错误 | 数据库连接失败时，记录错误并以失败退出 |

---

## 13. 测试用例索引

本节提供按功能模块分类的测试场景快速索引，便于测试人员定位具体测试点。

### 13.1 认证与授权测试

| 测试 ID | 测试场景 | 规格引用 |
|---------|----------|----------|
| AUTH-001 | 有效 Token 访问受保护资源 | REQ-AUTH-001 |
| AUTH-002 | 健康检查端点无需认证 | REQ-AUTH-001 |
| AUTH-003 | 无效/过期 Token 返回 401 | REQ-AUTH-001 |
| AUTH-004 | JWT Claims 正确映射到用户上下文 | REQ-AUTH-002 |
| AUTH-005 | 登录成功返回有效 JWT | REQ-AUTH-003 |
| AUTH-006 | 登录失败返回 401 | REQ-DS-006 |
| AUTH-007 | 密码使用 bcrypt 哈希 | REQ-AUTH-004 |
| AUTH-008 | Token 可通过查询参数传递 | REQ-EI-001 |

### 13.2 数据源管理测试

| 测试 ID | 测试场景 | 规格引用 |
|---------|----------|----------|
| DS-001 | 创建数据源成功 | REQ-DS-001 |
| DS-002 | 列出租户内所有数据源 | REQ-DS-001 |
| DS-003 | 更新数据源配置 | REQ-DS-001 |
| DS-004 | 软删除数据源 | REQ-DS-001 |
| DS-005 | 数据源连接测试成功 | REQ-DS-002 |
| DS-006 | 无效凭据连接测试失败 | REQ-DS-002 |
| DS-007 | 查询数据源表列表 | REQ-DS-003 |
| DS-008 | 查询表字段列表 | REQ-DS-003 |
| DS-009 | 跨租户数据源访问被拒绝 | REQ-DS-004 |
| DS-010 | 密码字段在响应中隐藏 | REQ-DS-005 |
| DS-011 | 复制数据源 | REQ-DS-009 |
| DS-012 | 重命名数据源 | REQ-DS-009 |
| DS-013 | 按关键字搜索数据源 | REQ-DS-010 |
| DS-014 | SSH 隧道密码认证 | REQ-DS-012 |
| DS-015 | SSH 隧道密钥认证 | REQ-DS-012 |
| DS-016 | 设置最大连接数 | REQ-DS-013 |
| DS-017 | 设置查询超时 | REQ-DS-013 |
| DS-018 | 验证支持的数据源类型 | REQ-DS-014 |
| DS-019 | 拒绝不支持的数据源类型 | REQ-DS-014 |

### 13.3 数据集管理测试

| 测试 ID | 测试场景 | 规格引用 |
|---------|----------|----------|
| DM-001 | 创建 SQL 数据集 | REQ-DM-001 |
| DM-002 | 创建 API 数据集 | REQ-DM-001 |
| DM-003 | 创建文件导入数据集 | REQ-DM-001 |
| DM-004 | 数据集字段自动提取 | REQ-DM-001 |
| DM-005 | 配置字段为维度 | REQ-DM-002 |
| DM-006 | 配置字段为度量 | REQ-DM-002 |
| DM-007 | 设置字段数据类型 | REQ-DM-002 |
| DM-008 | 配置字段分组 | REQ-DM-002 |
| DM-009 | 跨租户数据集访问被拒绝 | REQ-DM-003 |
| DM-010 | 数据集预览返回前 100 行 | REQ-DM-001 |
| DM-011 | 模式驱动预览渲染 | REQ-DM-004 |
| DM-012 | 预览失败返回可操作错误 | REQ-DM-005 |

### 13.4 数据集 API 测试

| 测试 ID | 测试场景 | 规格引用 |
|---------|----------|----------|
| DA-001 | 创建数据集 API 返回 201 | REQ-DA-001 |
| DA-002 | 列出数据集 API 分页 | REQ-DA-001 |
| DA-003 | 获取数据集详情 | REQ-DA-001 |
| DA-004 | 更新数据集 | REQ-DA-001 |
| DA-005 | 删除数据集 | REQ-DA-001 |
| DA-006 | 删除有引用的数据集返回 409 | REQ-DA-001 |
| DA-007 | 查询数据集数据 | REQ-DA-002 |
| DA-008 | 带过滤查询 | REQ-DA-002 |
| DA-009 | 带排序查询 | REQ-DA-002 |
| DA-010 | 带分页查询 | REQ-DA-002 |
| DA-011 | 预览数据集 | REQ-DA-003 |
| DA-012 | 列出数据集字段 | REQ-DA-004 |
| DA-013 | 创建计算字段 | REQ-DA-004 |
| DA-014 | 更新字段配置 | REQ-DA-004 |
| DA-015 | 删除计算字段 | REQ-DA-004 |
| DA-016 | 验证 SQL 查询 | REQ-DA-005 |
| DA-017 | 批量字段更新 | REQ-DA-006 |
| DA-018 | SQL 安全验证 | REQ-QSC-001 |
| DA-019 | 查询超时边界 | REQ-QSC-002 |
| DA-020 | 规范查询契约 | REQ-DA-008 |

### 13.5 计算字段测试

| 测试 ID | 测试场景 | 规格引用 |
|---------|----------|----------|
| CF-001 | 带字段引用创建计算字段 | REQ-CF-001 |
| CF-002 | 带算术运算符创建计算字段 | REQ-CF-001 |
| CF-003 | 带函数创建计算字段 | REQ-CF-001 |
| CF-004 | 设置计算字段类型 | REQ-CF-002 |
| CF-005 | 自动检测数据类型 | REQ-CF-002 |
| CF-006 | 表达式编辑器语法高亮 | REQ-CF-003 |
| CF-007 | 表达式编辑器自动完成 | REQ-CF-003 |
| CF-008 | 表达式验证 | REQ-CF-003 |
| CF-009 | SQL 查询中执行计算字段 | REQ-CF-004 |
| CF-010 | API 数据集中执行计算字段 | REQ-CF-004 |
| CF-011 | 嵌套计算字段执行 | REQ-CF-004 |
| CF-012 | 计算字段错误处理 | REQ-CF-004 |
| CF-013 | 计算字段缓存 | REQ-CF-005 |

### 13.6 批量字段与分组测试

| 测试 ID | 测试场景 | 规格引用 |
|---------|----------|----------|
| FBG-001 | 批量更新多个字段 | REQ-FBG-001 |
| FBG-002 | 批量更新部分失败反馈 | REQ-FBG-001 |
| FBG-003 | 创建分组字段 | REQ-FBG-002 |
| FBG-004 | 查询中使用分组字段 | REQ-FBG-002 |
| FBG-005 | 验证分组配置 | REQ-FBG-003 |
| FBG-006 | 现有数据集向后兼容 | REQ-FBG-003 |
| FBG-007 | 无选择批量提交阻止 | REQ-FBG-004 |

### 13.7 数据集编辑器 UI 测试

| 测试 ID | 测试场景 | 规格引用 |
|---------|----------|----------|
| DEU-001 | 打开数据集编辑器布局 | REQ-DEU-001 |
| DEU-002 | 保存操作保持当前页面 | REQ-DEU-002 |
| DEU-003 | 保存并返回导航到列表 | REQ-DEU-002 |
| DEU-004 | 保存失败保持上下文 | REQ-DEU-002 |
| DEU-005 | 标签页切换状态保持 | REQ-DEU-003 |
| DEU-006 | 刷新数据操作 | REQ-DEU-003 |

### 13.8 报表设计器测试

| 测试 ID | 测试场景 | 规格引用 |
|---------|----------|----------|
| RD-001 | 访问报表设计器 | REQ-RD-001 |
| RD-002 | 创建报表模板 | REQ-RD-002 |
| RD-003 | 单元格绑定数据源 | REQ-RD-003 |
| RD-004 | 报表预览显示数据 | REQ-RD-006 |
| RD-005 | 保存带数据绑定报表 | REQ-RD-007 |
| RD-006 | 加载带数据绑定报表 | REQ-RD-007 |
| RD-007 | 单元格绑定数据集 | REQ-RD-008 |
| RDU-001 | Canvas 设计器基本操作 | REQ-RDU-001 |
| RDU-002 | 单元格合并/取消合并 | REQ-RDU-001 |
| RDU-003 | 单元格样式应用 | REQ-RDU-001 |
| RDU-004 | 表达式编辑器 | REQ-RDU-003 |
| RDU-005 | 键盘快捷键 | REQ-RDU-006 |
| RDU-006 | 右键菜单 | REQ-RDU-007 |
| RDU-007 | 大报表性能（1000+ 单元格） | REQ-RDU-005 |

### 13.9 报表渲染与预览测试

| 测试 ID | 测试场景 | 规格引用 |
|---------|----------|----------|
| RR-001 | 通过 ID 渲染报表 | REQ-RR-001 |
| RR-002 | 遗留路由兼容 | REQ-RR-002 |
| RRU-001 | 报表预览带数据 | REQ-RRU-001 |
| RRU-002 | 报表分页 | REQ-RRU-002 |
| RRU-003 | 打印预览 | REQ-RRU-003 |
| RRU-004 | 导出对话框配置 | REQ-RRU-004 |
| RRU-005 | 导出进度显示 | REQ-RRU-005 |
| RRU-006 | 响应式设计 | REQ-RRU-007 |

### 13.10 报表导出测试

| 测试 ID | 测试场景 | 规格引用 |
|---------|----------|----------|
| RE-001 | 导出为 PDF | REQ-RE-001 |
| RE-002 | 导出为 Excel | REQ-RE-001 |
| RE-003 | 带参数导出 | REQ-RE-002 |

### 13.11 BI 仪表盘测试

| 测试 ID | 测试场景 | 规格引用 |
|---------|----------|----------|
| BD-001 | 访问仪表盘设计器 | REQ-BD-001 |
| BD-002 | 仪表盘 CRUD | REQ-BD-002 |
| BD-003 | 小部件绑定数据集 | REQ-BD-003 |
| BD-004 | 保存带数据集绑定仪表盘 | REQ-BD-003 |
| BDU-001 | 创建新仪表盘 | REQ-BDU-001 |
| BDU-002 | 组件拖放 | REQ-BDU-002 |
| BDU-003 | 图层管理 | REQ-BDU-004 |
| BDU-004 | 数据绑定 | REQ-BDU-005 |
| BDU-005 | 仪表盘预览 | REQ-BDU-006 |
| BDU-006 | 常用组件（文本卡片、图表等） | REQ-BDU-007 |
| BDU-007 | 大型仪表盘性能（50 组件） | REQ-BDU-008 |
| BDU-008 | 保存-加载一致性 | REQ-BDU-009 |

### 13.12 图表编辑器测试

| 测试 ID | 测试场景 | 规格引用 |
|---------|----------|----------|
| CEU-001 | 图表类型选择 | REQ-CEU-001 |
| CEU-002 | ECharts 集成 | REQ-CEU-002 |
| CEU-003 | SQL 数据源配置 | REQ-CEU-003 |
| CEU-004 | API 数据源配置 | REQ-CEU-003 |
| CEU-005 | 图表属性配置 | REQ-CEU-004 |
| CEU-006 | 实时预览 | REQ-CEU-005 |
| CEU-007 | 常用图表类型（柱状、折线、饼图等） | REQ-CEU-006 |
| CEU-008 | 图表交互（悬停、点击、缩放） | REQ-CEU-007 |
| CEU-009 | 大数据集性能（10,000 点） | REQ-CEU-008 |
| CEU-010 | 图表使用数据集数据源 | REQ-CEU-009 |
| CEU-011 | 计算字段在图表中使用 | REQ-CEU-009 |

### 13.13 查询缓存测试

| 测试 ID | 测试场景 | 规格引用 |
|---------|----------|----------|
| QC-001 | Redis 未启用降级到 Noop | REQ-QC-001 |
| QC-002 | Redis 运行时不可用降级 | REQ-QC-001 |
| QC-003 | 同租户重复查询命中缓存 | REQ-QC-002 |
| QC-004 | 跨租户缓存隔离 | REQ-QC-002 |
| QC-005 | TTL 到期后回源 | REQ-QC-003 |
| QC-006 | 资源更新触发缓存失效 | REQ-QC-003 |
| QC-007 | 缓存指标可追踪 | REQ-QC-004 |

### 13.14 前端功能可用性测试

| 测试 ID | 测试场景 | 规格引用 |
|---------|----------|----------|
| FFA-001 | 核心功能导航可见 | REQ-FFA-001 |
| FFA-002 | 部分实现模块非空白回退 | REQ-FFA-002 |
| FFA-003 | 仪表盘基线路径 | REQ-FFA-003 |
| FFA-004 | 图表基线路径 | REQ-FFA-003 |
| FFA-005 | 占位符禁用状态 | REQ-FFA-004 |
| FFA-006 | API 错误显示后端消息 | REQ-FFA-006 |

### 13.15 系统集成与兼容性测试

| 测试 ID | 测试场景 | 规格引用 |
|---------|----------|----------|
| MC-001 | 现有数据库兼容 | REQ-MC-001 |
| MC-002 | 遗留路由 `/jmreport/` 兼容 | REQ-MC-002 |
| MC-003 | 遗留路由 `/drag/` 兼容 | REQ-MC-002 |
| EI-001 | 查询参数 Token | REQ-EI-001 |
| EI-002 | CORS 配置 | REQ-EI-002 |
| DBC-001 | 环境变量数据库配置 | REQ-DBC-001 |
| DBC-002 | 数据库连接错误处理 | REQ-DBC-001 |

---

## 附录 A: 已归档变更记录

| 归档日期 | 变更 ID | 描述 |
|----------|---------|------|
| 2026-02-02 | migrate-go-backend | Go 后端迁移 |
| 2026-02-02 | build-custom-frontend | 自定义前端构建 |
| 2026-02-03 | mvp-report-designer | MVP 报表设计器 |
| 2026-02-05 | auth-datasource | 认证数据源 |
| 2026-02-05 | infrastructure-setup | 基础设施设置 |
| 2026-02-06 | update-ui-feature-visibility | UI 功能可见性更新 |
| 2026-02-09 | add-dataset-feature | 添加数据集功能 |
| 2026-02-09 | add-redis-cache-foundation | Redis 缓存基础 |
| 2026-02-09 | rename-module-goreport | 模块重命名为 goreport |
| 2026-02-09 | update-dataset-editor-workflow | 数据集编辑器工作流更新 |
| 2026-02-11 | add-datasource-advanced-connectivity-settings | 数据源高级连接设置 |
| 2026-02-11 | update-dataset-core-safety-and-batch-api | 数据集核心安全和批量 API |
| 2026-02-11 | update-dataset-editor-workflow-and-preview | 数据集编辑器工作流和预览 |
| 2026-02-11 | update-datasource-management-operations | 数据源管理操作更新 |
| 2026-02-12 | update-dashboard-designer-runtime-consistency | 仪表盘设计器运行时一致性 |
| 2026-02-12 | update-dataset-query-contract-alignment | 数据集查询契约对齐 |
| 2026-02-12 | update-placeholder-and-error-ux-hardening | 占位符和错误 UX 加固 |

---

## 附录 B: API 端点摘要

### 认证 API
| 方法 | 端点 | 描述 |
|------|------|------|
| POST | /api/v1/auth/login | 用户登录 |
| POST | /api/v1/auth/logout | 用户登出 |

### 数据源 API
| 方法 | 端点 | 描述 |
|------|------|------|
| GET | /api/v1/datasources | 列出数据源 |
| POST | /api/v1/datasources | 创建数据源 |
| GET | /api/v1/datasources/:id | 获取数据源 |
| PUT | /api/v1/datasources/:id | 更新数据源 |
| DELETE | /api/v1/datasources/:id | 删除数据源 |
| POST | /api/v1/datasources/:id/test | 测试连接 |
| GET | /api/v1/datasources/:id/tables | 获取表列表 |
| GET | /api/v1/datasources/:id/tables/:table/fields | 获取字段列表 |

### 数据集 API
| 方法 | 端点 | 描述 |
|------|------|------|
| GET | /api/v1/datasets | 列出数据集 |
| POST | /api/v1/datasets | 创建数据集 |
| GET | /api/v1/datasets/:id | 获取数据集 |
| PUT | /api/v1/datasets/:id | 更新数据集 |
| DELETE | /api/v1/datasets/:id | 删除数据集 |
| POST | /api/v1/datasets/:id/data | 查询数据集数据 |
| GET | /api/v1/datasets/:id/preview | 预览数据集 |
| GET | /api/v1/datasets/:id/fields | 列出字段 |
| POST | /api/v1/datasets/:id/fields | 创建计算字段 |
| PUT | /api/v1/datasets/:id/fields/:fieldId | 更新字段 |
| DELETE | /api/v1/datasets/:id/fields/:fieldId | 删除计算字段 |
| PATCH | /api/v1/datasets/:id/fields | 批量更新字段 |
| POST | /api/v1/datasets/validate | 验证数据集配置 |
| GET | /api/v1/datasets/:id/dimensions | 获取维度列表 |
| GET | /api/v1/datasets/:id/measures | 获取度量列表 |
| GET | /api/v1/datasets/:id/schema | 获取数据集模式 |

### 报表 API
| 方法 | 端点 | 描述 |
|------|------|------|
| GET | /api/v1/jmreport/list | 列出报表 |
| POST | /api/v1/jmreport/create | 创建报表 |
| GET | /api/v1/jmreport/:id | 获取报表 |
| PUT | /api/v1/jmreport/update | 更新报表 |
| DELETE | /api/v1/jmreport/:id | 删除报表 |
| POST | /api/v1/jmreport/preview | 预览报表 |

### 仪表盘 API
| 方法 | 端点 | 描述 |
|------|------|------|
| GET | /api/v1/drag/list | 列出仪表盘 |
| POST | /api/v1/drag/create | 创建仪表盘 |
| GET | /api/v1/drag/:id | 获取仪表盘 |
| PUT | /api/v1/drag/update | 更新仪表盘 |
| DELETE | /api/v1/drag/:id | 删除仪表盘 |

### 缓存 API
| 方法 | 端点 | 描述 |
|------|------|------|
| GET | /api/v1/cache/metrics | 缓存指标 |

### 健康检查
| 方法 | 端点 | 描述 |
|------|------|------|
| GET | /health | 健康检查 |

---

**文档结束**

*此文档基于 OpenSpec 规范自动生成，包含 22 个能力规格和 19 个已归档变更。如需更新，请运行 OpenSpec 命令重新生成。*
