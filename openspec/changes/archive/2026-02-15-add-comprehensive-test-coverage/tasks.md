## 1. 测试能力规格定义

> **参考文档**: `test-plan.md` - 完整系统测试计划（123 个测试用例）

- [x] 1.0 验收 `test-plan.md` 作为测试执行指南

- [x] 1.1 创建 `testing-coverage` 能力规格文件 `openspec/specs/testing-coverage/spec.md`
- [x] 1.2 定义测试覆盖率要求（后端 ≥80%，前端 ≥70%）
- [x] 1.3 定义测试类型层次（单元/集成/E2E）
- [x] 1.4 定义测试场景与需求映射规则

## 2. 后端测试工具增强

- [x] 2.1 扩展 `testutil/test_helper.go` 添加 `TestFixture` 接口
- [x] 2.2 添加 `TenantTestContext` 结构支持租户隔离测试
- [x] 2.3 创建 `fixtures_auth.go` 认证测试数据工厂
- [x] 2.4 创建 `fixtures_datasource.go` 数据源测试数据工厂
- [ ] 2.5 创建 `fixtures_report.go` 报表测试数据工厂（延后 - 无 report 模型）
- [ ] 2.6 添加 Mock 工具函数（Redis、外部 API）（现有 cache.NoopProvider 可用）

## 3. 执行测试用例 - 认证与授权 (12 用例)

> test-plan.md 6.1 节 - 当前覆盖率: 60.2%

- [x] TC-AUTH-001 用户登录 - 正常场景
- [x] TC-AUTH-002 用户登录 - 无效密码
- [x] TC-AUTH-003 用户登录 - 用户不存在
- [x] TC-AUTH-004 用户登录 - 空用户名/密码
- [ ] TC-AUTH-005 用户登录 - SQL 注入尝试 (需手动验证)
- [x] TC-AUTH-006 有效 Token 访问受保护 API
- [x] TC-AUTH-007 无 Token 访问受保护 API
- [x] TC-AUTH-008 过期 Token 访问受保护 API
- [x] TC-AUTH-009 篡改 Token 访问受保护 API
- [x] TC-AUTH-010 健康检查端点无需认证
- [x] TC-AUTH-011 通过 URL 参数传递 Token
- [ ] TC-AUTH-012 用户登出 - 正常场景 (Redis 测试跳过)

## 4. 执行测试用例 - 数据源管理 (18 用例)

> test-plan.md 6.2 节 - 当前覆盖率: 60.9%

- [x] TC-DS-001 创建数据源 - MySQL 正常场景
- [x] TC-DS-002 创建数据源 - 缺少必填字段
- [x] TC-DS-003 创建数据源 - 不支持的类型
- [x] TC-DS-004 列出数据源 - 正常场景
- [x] TC-DS-005 更新数据源 - 正常场景
- [x] TC-DS-006 删除数据源 - 正常场景
- [ ] TC-DS-007 删除数据源 - 被数据集引用 (需 DB 环境)
- [ ] TC-DS-008 连接测试 - 成功 (需真实数据库)
- [ ] TC-DS-009 连接测试 - 无效凭据 (需真实数据库)
- [ ] TC-DS-010 连接测试 - 网络不通 (需真实数据库)
- [ ] TC-DS-011 查询表列表 - 正常场景 (需 DB 环境)
- [ ] TC-DS-012 查询字段列表 - 正常场景 (需 DB 环境)
- [x] TC-DS-013 跨租户访问数据源 - 被拒绝
- [x] TC-DS-014 数据源列表仅返回当前租户数据
- [ ] TC-DS-015 SSH 隧道 - 密码认证 (需真实 SSH 服务器)
- [ ] TC-DS-016 SSH 隧道 - 密钥认证 (需真实 SSH 服务器)
- [x] TC-DS-017 设置最大连接数
- [x] TC-DS-018 设置查询超时

## 5. 执行测试用例 - 数据集管理 (24 用例)

> test-plan.md 6.3 节 - 当前覆盖率: 69.1%

- [x] TC-DM-001 创建 SQL 数据集 - 正常场景
- [x] TC-DM-002 创建数据集 - 无效 SQL
- [x] TC-DM-003 创建数据集 - 危险 SQL 被拒绝
- [x] TC-DM-004 列出数据集 - 分页
- [x] TC-DM-005 获取数据集详情
- [x] TC-DM-006 更新数据集 - 查询更改后重新提取字段
- [ ] TC-DM-007 删除数据集 - 有引用时返回冲突 (需 DB 环境)
- [ ] TC-DM-008 查询数据集数据 - 正常场景 (需 DB 环境)
- [ ] TC-DM-009 查询数据集数据 - 带过滤 (需 DB 环境)
- [ ] TC-DM-010 查询数据集数据 - 带排序 (需 DB 环境)
- [ ] TC-DM-011 查询数据集数据 - 带分页 (需 DB 环境)
- [ ] TC-DM-012 数据集预览 - 返回前 100 行 (需 DB 环境)
- [x] TC-DM-013 配置字段为维度
- [x] TC-DM-014 配置字段为度量
- [x] TC-DM-015 批量更新字段
- [x] TC-DM-016 创建计算字段 - 简单表达式
- [x] TC-DM-017 创建计算字段 - 使用函数
- [x] TC-DM-018 创建计算字段 - 无效表达式
- [ ] TC-DM-019 查询数据 - 计算字段正确计算 (需 DB 环境)
- [x] TC-DM-020 删除计算字段 - 原始字段不可删除
- [x] TC-DM-021 拒绝危险 SQL - DELETE 语句
- [x] TC-DM-022 拒绝危险 SQL - DROP 语句
- [x] TC-DM-023 查询超时保护
- [x] TC-DM-024 分页边界保护

## 6. 执行测试用例 - 报表设计器 (12 用例)

> test-plan.md 6.4 节 - 当前覆盖率: 68.8%

- [ ] TC-RD-001 打开报表设计器 (需 DB 环境)
- [x] TC-RD-002 单元格选择和编辑
- [x] TC-RD-003 单元格合并
- [x] TC-RD-004 单元格样式设置
- [x] TC-RD-005 键盘快捷键 - 复制粘贴
- [x] TC-RD-006 键盘快捷键 - 撤销/重做
- [ ] TC-RD-007 单元格绑定数据源字段 (需 DB 环境)
- [ ] TC-RD-008 单元格绑定度量并聚合 (需 DB 环境)
- [x] TC-RD-009 表达式编辑器使用
- [ ] TC-RD-010 保存新报表 (需 DB 环境)
- [ ] TC-RD-011 加载已保存报表 (需 DB 环境)
- [x] TC-RD-012 自动保存触发

## 7. 执行测试用例 - 报表渲染与预览 (6 用例)

> test-plan.md 6.5 节

- [ ] TC-RR-001 报表预览 - 数据正确渲染 (需 DB 环境)
- [ ] TC-RR-002 报表预览 - 带参数过滤 (需 DB 环境)
- [x] TC-RR-003 报表预览 - 刷新数据
- [ ] TC-RR-004 报表分页 - 大数据集 (需 DB 环境)
- [ ] TC-RR-005 报表分页 - 翻页操作 (需 DB 环境)
- [x] TC-RR-006 打印预览 - A4 纵向

## 8. 执行测试用例 - 报表导出 (3 用例)

> test-plan.md 6.6 节

- [ ] TC-RE-001 导出 PDF (需集成测试环境)
- [ ] TC-RE-002 导出 Excel (需集成测试环境)
- [ ] TC-RE-003 导出 - 大数据量 (需集成测试环境)

## 9. 执行测试用例 - BI 仪表盘 (7 用例)

> test-plan.md 6.7 节 - 当前覆盖率: 68.3%

- [x] TC-BD-001 创建新仪表盘
- [x] TC-BD-002 拖放组件到画布
- [x] TC-BD-003 组件数据绑定
- [ ] TC-BD-004 图层管理 - 重新排序 (需 DB 环境)
- [ ] TC-BD-005 保存仪表盘 (需 DB 环境)
- [ ] TC-BD-006 加载已保存仪表盘 (需 DB 环境)
- [x] TC-BD-007 仪表盘预览模式

## 10. 执行测试用例 - 图表编辑器 (7 用例)

> test-plan.md 6.8 节 - 当前覆盖率: 77.1%

- [x] TC-CE-001 选择柱状图
- [x] TC-CE-002 选择折线图
- [x] TC-CE-003 选择饼图
- [x] TC-CE-004 图表绑定数据集
- [ ] TC-CE-005 图表实时预览更新 (需 DB 环境)
- [x] TC-CE-006 图表悬停提示
- [ ] TC-CE-007 图例切换 (需 DB 环境)

## 11. 执行测试用例 - 查询缓存 (4 用例)

> test-plan.md 6.9 节 - 当前覆盖率: 63.5%

- [ ] TC-QC-001 Redis 缓存命中 (需 Redis 环境)
- [x] TC-QC-002 缓存租户隔离
- [x] TC-QC-003 Redis 不可用时降级
- [x] TC-QC-004 数据更新后缓存失效

## 12. 执行测试用例 - 前端功能可用性 (4 用例)

> test-plan.md 6.10 节 - 前端测试: 332 passed

- [x] TC-FFA-001 核心功能导航可见
- [x] TC-FFA-002 直接访问核心路由
- [x] TC-FFA-003 API 错误显示后端消息
- [x] TC-FFA-004 网络错误优雅处理

## 13. 执行测试用例 - 系统集成与兼容性 (4 用例)

> test-plan.md 6.11 节

- [x] TC-MC-001 遗留路由 /jmreport/ 兼容
- [x] TC-MC-002 遗留路由 /drag/ 兼容
- [x] TC-EI-001 CORS 允许配置的来源
- [x] TC-EI-002 CORS 拒绝未配置的来源

## 14. 执行测试用例 - 性能测试 (5 用例)

> test-plan.md 6.12 节

- [ ] TC-PERF-001 数据集查询响应时间 (< 2s) (需专用环境)
- [ ] TC-PERF-002 报表预览响应时间 (< 3s) (需专用环境)
- [ ] TC-PERF-003 仪表盘加载时间 (< 5s) (需专用环境)
- [ ] TC-PERF-004 并发查询测试 (100 并发) (需专用环境)
- [ ] TC-PERF-005 大数据集分页查询 (100K 行) (需专用环境)

## 15. 执行测试用例 - 安全测试 (6 用例)

> test-plan.md 6.13 节

- [x] TC-SEC-001 数据集查询 SQL 注入
- [ ] TC-SEC-002 报表内容 XSS (需渗透测试)
- [ ] TC-SEC-003 水平越权 - 访问其他用户数据 (需渗透测试)
- [ ] TC-SEC-004 垂直越权 - 普通用户执行管理员操作 (需渗透测试)
- [x] TC-SEC-005 数据源密码不返回
- [x] TC-SEC-006 错误信息不含敏感数据

## 16. CI/CD 集成

- [x] 16.1 创建覆盖率检查脚本 `scripts/ci/check-coverage.sh`
- [x] 16.2 更新 `.github/workflows/test.yml` 添加覆盖率步骤
- [ ] 16.3 配置覆盖率报告上传（Codecov/Coveralls）（需仓库配置）
- [ ] 16.4 添加覆盖率徽章到 README.md（需仓库权限）

## 17. 文档更新

- [ ] 17.1 更新 `AGENTS.md` 添加测试指南
- [ ] 17.2 创建 `docs/TESTING.md` 测试指南文档
- [ ] 17.3 更新 `test-plan.md` 关联 OpenSpec 需求

## 18. 验证与归档

- [x] 18.1 运行完整测试套件验证覆盖率目标 (后端 81.2% ✅, 前端 332 passed)
- [x] 18.2 验证 CI 覆盖率门禁正常工作 (55% 门禁通过)
- [x] 18.3 输出验证报告 `verification-report.md`
- [x] 18.4 OpenSpec 验证 `openspec validate add-comprehensive-test-coverage --strict`

---

## 19. 剩余工作 (后续迭代)

### 19.1 测试用例补充

以下测试用例需要专用环境或手动验证：

| 类型 | 用例数 | 环境要求 |
|------|--------|----------|
| SSH 隧道测试 | 2 | 真实 SSH 服务器 |
| 性能测试 | 5 | 独立性能测试环境 |
| 渗透测试 | 3 | 安全测试工具 |
| 手动验证 | 2 | SQL 注入、Redis 登出 |

### 19.2 覆盖率提升

| 模块 | 当前 | 目标 | 差距 |
|------|------|------|------|
| auth | 60.2% | 80% | +19.8% |
| datasource | 60.9% | 80% | +19.1% |
| dataset | 69.1% | 80% | +10.9% |
| render | 56.0% | 70% | +14.0% |
| dashboard | 68.3% | 80% | +11.7% |

### 19.3 基础设施

- [ ] 配置 Codecov/Coveralls 覆盖率上传
- [ ] 添加覆盖率徽章到 README.md
- [ ] 创建 `docs/TESTING.md` 测试指南

---

**统计**: 68/123 测试用例已验证通过 (单元测试), 55 需 DB/专用环境

**DB 集成测试结果 (2026-02-15 16:15 最终更新)**:
- repository: 84.2% (38 测试通过)
- database: 83.8%
- datasource: 75.8% (含 DB 测试)
- dataset: 84.7% (含 DB 测试)
- models: 87.5%
- auth: 87.5% (含 DB 测试)
- cache: 80.2%
- dashboard: 90.2% (含 DB 测试)
- httpserver/handlers: 77.1% (含 DB 测试)
- report: 89.8% (含 DB 测试)
- render: 81.0% (含 DB 测试)
- testutil: 78.3%
- **后端总覆盖率 (含 DB): 81.2% ✅ 目标达成**

**详细统计 (单元测试)**:
- 认证与授权: 10/12 ✅
- 数据源管理: 11/18 ✅
- 数据集管理: 16/24 ✅
- 报表设计器: 6/12 ✅
- 报表渲染: 2/6 ✅
- 报表导出: 0/3 ⏳
- BI 仪表盘: 4/7 ✅
- 图表编辑器: 5/7 ✅
- 查询缓存: 3/4 ✅
- 前端功能: 4/4 ✅
- 系统集成: 4/4 ✅
- 性能测试: 0/5 ⏳
- 安全测试: 3/6 ✅

**覆盖率详情 (后端 - 含 DB)**:
| 模块 | 覆盖率 | 目标 | 状态 |
|------|--------|------|------|
| config | 100.0% | 80% | ✅ |
| httpserver | 98.0% | 80% | ✅ |
| middleware | 90.5% | 80% | ✅ |
| dashboard | 90.2% | 80% | ✅ |
| report | 89.8% | 80% | ✅ |
| models | 87.5% | 70% | ✅ |
| auth | 87.5% | 80% | ✅ |
| chart | 85.7% | 70% | ✅ |
| repository | 84.2% | 80% | ✅ |
| database | 83.8% | 70% | ✅ |
| dataset | 84.7% | 80% | ✅ |
| render | 81.0% | 70% | ✅ |
| cache | 80.2% | 70% | ✅ |
| httpserver/handlers | 77.1% | 80% | ⚠️ |
| datasource | 75.8% | 80% | ⚠️ |
| testutil | 78.3% | 70% | ✅ |

**本次提升总结 (从 66.3% 到 81.2%)**:
| 模块 | 之前 | 之后 | 提升 |
|------|------|------|------|
| render | 51.0% | 81.0% | +30.0% |
| repository | 4.1% | 84.2% | +80.1% |
| database | 10.8% | 83.8% | +73.0% |
| dashboard | 76.4% | 90.2% | +13.8% |
| report | 82.0% | 89.8% | +7.8% |
| auth | 79.5% | 87.5% | +8.0% |
| dataset | 72.6% | 84.7% | +12.1% |
| datasource | 66.5% | 75.8% | +9.3% |
| handlers | 69.6% | 77.1% | +7.5% |
| testutil | 44.6% | 78.3% | +33.7% |
| **总计** | 66.3% | 81.2% | **+14.9%** |
