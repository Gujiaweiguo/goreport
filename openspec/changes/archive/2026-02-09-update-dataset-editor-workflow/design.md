## Context

### Current State
当前数据集编辑能力已具备基础创建、预览和字段配置，但与目标界面在交互流程上不一致，主要体现在：
- 缺少独立的“批量管理”工作区，字段批量调整效率低。
- “分组字段”缺少独立入口，用户难以理解其与维度/聚合的关系。
- “保存”与“保存并返回”动作语义未形成稳定契约，前端状态与持久化反馈存在歧义。
- “数据预览/批量管理”切换与“刷新数据”缺少明确状态机与错误处理约定。

### Constraints
- 不新增外部依赖，复用 Vue3 + TS、Go + Gin + GORM 现有栈。
- 优先非 breaking 方式演进 API；保留现有数据集与可视化绑定兼容性。
- 仅改动数据集编辑相关模块，避免影响报表/图表/仪表盘已上线路径。

### Stakeholders
- 报表设计与数据分析用户（需要更快完成字段编排）。
- 前端与后端开发（需要一致的字段模型与动作语义）。
- 测试与运维（需要可回归、可观测的状态流转）。

## Goals / Non-Goals

**Goals:**
- 定义并落地数据集编辑页标准工作流（结构、动作、状态机）。
- 引入批量管理能力，支持字段类型/备注/排序等批量变更。
- 引入分组字段独立入口，统一其在维度与聚合流程中的行为。
- 规范保存类动作的前后端契约（保存、保存并返回）。
- 明确预览与刷新行为及异常提示，保证可预测用户体验。

**Non-Goals:**
- 不重构数据集底层存储模型。
- 不变更报表/图表/仪表盘绑定协议本身。
- 不引入新的权限模型或多租户策略变化。

## Decisions

### 1) 页面工作流采用“动作优先 + 分区布局”
**Decision**: 编辑页采用顶部动作区（保存、保存并返回、刷新）+ 左侧数据源/数据表区 + 主体字段管理区（维度/指标分区，含标签切换）。

**Rationale**:
- 与目标界面一致，降低学习成本。
- 将“动作”与“配置内容”解耦，减少误操作。

**Alternatives Considered**:
- 单列线性表单：实现简单，但复杂字段操作可见性差。
- 抽屉式配置：信息密度过高，批量操作路径更长。

### 2) 批量管理采用“原子字段补丁”接口
**Decision**: 前端按字段集合提交 patch（仅变更字段），后端进行统一校验后批量落库。

**Rationale**:
- 避免全量覆盖造成并发覆盖与无关字段抖动。
- 便于服务端做字段级错误回传与部分失败控制策略。

**Alternatives Considered**:
- 全量字段替换：简单但风险高，回滚粒度粗。
- 前端循环单条更新：请求过多且一致性较差。

### 3) 分组字段建模为“可配置维度能力”
**Decision**: 分组字段不是独立数据类型，而是维度字段上的分组能力配置（包含分组规则与可用性校验）。

**Rationale**:
- 与现有 dimension/measure 模型兼容，避免新增第三类字段破坏既有协议。
- 查询侧更容易映射到 GROUP BY/CASE WHEN 规则。

**Alternatives Considered**:
- 新增 `group` 字段类型：语义直观，但会扩大上下游兼容成本。

### 4) 保存动作定义双语义契约
**Decision**:
- `保存`：成功后停留当前页，刷新本地状态并提示成功。
- `保存并返回`：成功后返回列表页，失败保持当前页并保留上下文。

**Rationale**:
- 语义清晰，可稳定自动化测试与用户预期。

**Alternatives Considered**:
- 前端仅靠按钮文案分支且无后端契约：易产生状态不一致。

### 5) 预览与刷新引入轻量状态机
**Decision**: 在前端定义 `idle/loading/success/error` 状态，切换标签与刷新共用同一数据加载管道。

**Rationale**:
- 统一错误处理和 loading 展示，减少重复逻辑。
- 便于回归测试覆盖关键状态转换。

**Alternatives Considered**:
- 各功能独立异步逻辑：实现快但后续维护成本高。

## Risks / Trade-offs

- **[Risk] 批量更新引入字段并发冲突** → **Mitigation**: 增加版本戳/更新时间校验，冲突时返回可读错误并提示刷新后重试。
- **[Risk] 分组规则错误导致查询性能下降** → **Mitigation**: 对规则做白名单校验，预览接口限制样本量并返回执行耗时。
- **[Risk] 新工作流影响已有编辑页行为** → **Mitigation**: 通过特性开关或渐进发布，先在数据集编辑页灰度验证。
- **[Risk] 动作语义落地不一致（前后端）** → **Mitigation**: 在 specs 中固化动作场景，并补充集成测试。

## Migration Plan

1. 在不变更现有 API 路径前提下，补充批量更新与分组字段能力（可先以可选参数方式扩展）。
2. 前端先接入新工作流骨架与状态机，保持原编辑能力可用。
3. 接入批量管理与分组字段入口，完成端到端联调。
4. 增加回归用例：保存、保存并返回、刷新、标签切换、批量更新失败回滚提示。
5. 灰度发布后观察错误日志与用户反馈，再默认开启。

**Rollback:**
- 前端可通过路由/配置开关回退到旧编辑页逻辑。
- 后端保留旧参数兼容分支，禁用新增批量/分组入口即可回滚行为。

## Open Questions

- 批量更新采用“全成功”还是“允许部分成功并返回失败明细”？
- 分组字段规则是否支持多层分组（当前建议先单层）。
- 保存并返回是否需要二次确认（存在未保存变更时）？
- 是否需要在列表页增加“最近编辑失败”状态提示以便追踪？
