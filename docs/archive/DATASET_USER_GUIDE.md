# 数据集功能用户指南

## 概述

数据集（Dataset）是 goReport 系统的核心功能，允许用户将多个数据源组合成一个统一的数据模型，支持维度、指标、计算字段和多种数据源类型。

## 核心概念

### 1. 数据集类型

数据集支持三种类型：

- **SQL 数据集**：基于 SQL 查询从数据库获取数据
- **API 数据集**：通过 REST API 获取数据
- **File 数据集**：从上传的文件（CSV、Excel 等）加载数据

### 2. 字段类型

数据集包含三种字段类型：

- **维度（Dimension）**：用于分组和筛选的类别字段（如地区、产品类别）
- **指标（Measure）**：可聚合的数值字段（如销售额、订单量）
- **计算字段（Computed Field）**：基于现有字段计算的新字段（如增长率 = (本期销售额 - 上期销售额) / 上期销售额 * 100）

## 快速开始

### 创建数据集

1. 登录系统后，进入"数据集"页面
2. 点击"新建数据集"按钮
3. 填写基本信息：
   - **名称**：数据集的显示名称
   - **描述**：可选的描述信息
   - **类型**：选择数据集类型（SQL/API/文件）
4. 根据类型配置数据源：
   - SQL 类型：选择数据源、编写 SQL 查询
   - API 类型：输入 API URL 和请求配置
   - 文件类型：上传数据文件
5. 点击"保存"创建数据集

### 配置字段

创建数据集后，需要配置字段：

1. 在数据集列表中，点击目标数据集的"编辑"按钮
2. 进入"字段配置"标签页
3. 添加维度字段：
   - 点击"添加维度"按钮
   - 输入字段名称和显示名称
   - 选择字段类型（字符串/数字/日期/布尔）
   - 设置是否可排序、可分组
4. 添加指标字段：
   - 点击"添加指标"按钮
   - 输入字段名称和显示名称
   - 选择字段类型（数字）
   - 设置默认聚合函数（SUM/AVG/COUNT/MAX/MIN）
5. 创建计算字段（可选）：
   - 点击"添加计算字段"按钮
   - 输入字段名称和显示名称
   - 在表达式编辑器中编写计算公式
   - 可使用内置函数（如 SUM、AVG、COUNT）和现有字段引用

### 在报表中使用数据集

1. 进入报表设计器
2. 选择要绑定数据的单元格
3. 在右侧属性面板中，选择"数据绑定类型"为"数据集"
4. 选择数据集
5. 选择维度字段（用于分组）或指标字段（用于显示数值）
6. 选择聚合函数（如 SUM、AVG）
7. 保存配置

### 在仪表盘中使用数据集

1. 进入仪表盘编辑器
2. 选择要配置的组件
3. 在右侧属性面板中，选择"数据绑定类型"为"数据集"
4. 选择数据集、维度、指标和聚合函数
5. 保存配置

### 在图表中使用数据集

1. 进入图表编辑器
2. 在"数据配置"面板中，选择"数据绑定类型"为"数据集"
3. 选择数据集
4. 选择维度（X 轴）和指标（Y 轴）
5. 选择聚合函数
6. 应用配置并预览图表

## 高级功能

### 计算字段表达式

计算字段支持以下操作和函数：

#### 基础运算
- `+`：加法
- `-`：减法
- `*`：乘法
- `/`：除法
- `%`：取模

#### 聚合函数
- `SUM(field)`：求和
- `AVG(field)`：平均值
- `COUNT(field)`：计数
- `MIN(field)`：最小值
- `MAX(field)`：最大值

#### 条件函数
- `IF(condition, true_value, false_value)`：条件判断
- `CASE WHEN ... THEN ... ELSE ... END`：多条件判断

#### 字符串函数
- `CONCAT(field1, field2)`：字符串连接
- `SUBSTRING(field, start, length)`：子字符串
- `UPPER(field)`：转大写
- `LOWER(field)`：转小写

#### 日期函数
- `YEAR(date_field)`：提取年份
- `MONTH(date_field)`：提取月份
- `DAY(date_field)`：提取日期
- `DATE_DIFF(date_field1, date_field2, unit)`：日期差值

#### 示例

1. 计算增长率
   ```
   (sales - last_year_sales) / last_year_sales * 100
   ```

2. 计算毛利率
   ```
   (sales - cost) / sales * 100
   ```

3. 条件分类
   ```
   IF(sales > 10000, 'VIP', '普通')
   ```

### 数据预览

在数据集编辑器中，可以预览数据：

1. 配置完数据源后，点击"预览数据"按钮
2. 查看返回的数据样本
3. 验证数据是否符合预期

### 字段引用

在表达式编辑器中，可以通过以下方式引用字段：

- **SQL 表达式**：使用 `@{field_name}` 引用字段
- **API 表达式**：使用 `$.field_name` 引用字段
- **文件表达式**：使用 `@field_name` 引用字段

示例：
```
@sales_amount * @quantity
```

## 最佳实践

### 1. 数据集设计

- **单一职责**：每个数据集专注于一个业务领域（如销售数据集、库存数据集）
- **字段命名**：使用清晰的命名（如 `sales_amount` 而不是 `s1`）
- **显示名称**：为每个字段提供用户友好的显示名称（如"销售额"而不是 `sales_amount`）

### 2. 性能优化

- **SQL 查询**：添加适当的索引，避免全表扫描
- **计算字段**：尽量在数据源层面计算，减少实时计算压力
- **缓存**：启用系统缓存，提升查询性能

### 3. 数据安全

- **权限控制**：确保用户只能访问授权的数据集
- **租户隔离**：数据集按租户隔离，防止数据泄露
- **SQL 注入**：系统会自动转义 SQL 参数，防止注入攻击

### 4. 错误处理

- **验证数据源**：创建数据集前，先测试数据源连接
- **字段类型**：确保字段类型与实际数据类型匹配
- **表达式验证**：保存前验证表达式语法是否正确

## 常见问题

### Q1: 数据集预览没有数据？

**A**: 可能的原因：
1. 数据源配置错误，检查连接参数
2. SQL 查询条件过严，放宽 WHERE 条件
3. API 返回格式不正确，检查 API 文档

### Q2: 计算字段显示错误？

**A**: 检查：
1. 表达式语法是否正确
2. 引用的字段是否存在
3. 字段类型是否支持该运算（如字符串不能求和）

### Q3: 图表显示不正确？

**A**: 检查：
1. 维度和指标是否选择正确
2. 聚合函数是否符合业务逻辑
3. 数据集是否有数据

### Q4: SQL 数据集如何处理参数？

**A**: SQL 查询中使用 `:param_name` 作为参数占位符：
```sql
SELECT * FROM sales WHERE create_time >= :start_date AND create_time < :end_date
```

### Q5: 如何导入导出数据集？

**A**:
- **导入**：使用文件类型数据集，上传 CSV 或 Excel 文件
- **导出**：在数据集列表中，点击"导出"按钮，选择导出格式

## 下一步

学习更多功能：
- [报表设计器指南](./USER_GUIDE.md)
- [仪表盘编辑器指南](./USER_GUIDE.md#dashboard)
- [图表编辑器指南](./USER_GUIDE.md#chart)
- [API 文档](./API_REFERENCE.md)

需要帮助？
- 查看 [开发指南](./DEVELOPMENT_GUIDE.md)
- 提交 [GitHub Issue](https://github.com/gujiaweiguo/goreport/issues)
- 联系技术支持：[weiguogu@163.com](mailto:weiguogu@163.com)
