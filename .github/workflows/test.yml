name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  backend-lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'
          cache-dependency-path: backend/go.sum

      - name: Verify go.mod
        working-directory: backend
        run: go mod verify

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          working-directory: backend

  backend-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'
          cache-dependency-path: backend/go.sum

      - name: Run tests with coverage
        run: |
          cd backend
          go test -coverprofile=coverage.out ./... -v
          go tool cover -html=coverage.out -o coverage.html

      - name: Check coverage threshold (55%)
        run: ./scripts/ci/check-coverage.sh backend/coverage.out 55

      - name: Upload coverage report
        uses: actions/upload-artifact@v7
        if: always()
        with:
          name: backend-coverage
          path: backend/coverage.html
          retention-days: 7

  backend-check-with-db:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: goreport_test
          MYSQL_USER: goreport
          MYSQL_PASSWORD: goreport
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u root -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'
          cache-dependency-path: backend/go.sum

      - name: Wait for MySQL to be ready
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -u root -proot --silent 2>/dev/null; then
              echo "MySQL is ready!"
              break
            fi
            echo "Waiting for MySQL... ($i/30)"
            sleep 2
          done

      - name: Initialize test database schema
        run: |
          # Replace goreport with goreport_test in init.sql for CI
          sed 's/goreport/goreport_test/g' backend/db/init.sql | mysql -h 127.0.0.1 -u root -proot goreport_test

      - name: Run tests with database
        env:
          DB_DSN: root:root@tcp(127.0.0.1:3306)/goreport_test?charset=utf8mb4&parseTime=True&loc=Local
          TEST_DB_DSN: root:root@tcp(127.0.0.1:3306)/goreport_test?charset=utf8mb4&parseTime=True&loc=Local
          REDIS_ADDR: 127.0.0.1:6379
        run: |
          cd backend
          go test -coverprofile=coverage-db.out ./internal/repository/... ./internal/dataset/... ./internal/datasource/... -v
          
      - name: Check repository coverage
        run: |
          cd backend
          go tool cover -func=coverage-db.out | grep -E "repository|total"

      - name: Upload database test coverage
        uses: actions/upload-artifact@v7
        if: always()
        with:
          name: backend-coverage-db
          path: backend/coverage-db.out
          retention-days: 7

  frontend-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Type check
        working-directory: frontend
        run: npm run typecheck

      - name: Build
        working-directory: frontend
        run: npm run build

      - name: Run tests with coverage
        working-directory: frontend
        run: npm run test:run -- --coverage --passWithNoTests

      - name: Check coverage threshold (60%)
        run: ./scripts/ci/check-frontend-coverage.sh 60

      - name: Upload coverage report
        uses: actions/upload-artifact@v7
        if: always()
        with:
          name: frontend-coverage
          path: frontend/coverage/
          retention-days: 7

  security-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'
          cache-dependency-path: backend/go.sum

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache-dependency-path: frontend/package-lock.json

      - name: Check backend dependencies (govulncheck)
        working-directory: backend
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Check frontend dependencies
        working-directory: frontend
        run: npm audit --audit-level=high

  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, MPL-2.0, LGPL-3.0
